<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SupaReports ‚Äî Upgrade Your Insights</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&family=Russo+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rethink+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-teal: #0A1A22;
            --accent-gold: #d946ef;
            --glass-light: rgba(232, 236, 239, 0.1);
            --glass-border: rgba(255, 255, 255, 0.18);
            --text-primary: #1a2832;
            --text-secondary: rgba(26, 40, 50, 0.7);
            --shadow: rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-teal);
            color: var(--text-primary);
            overflow-x: auto;
            overflow-y: hidden;
            height: 100vh;
            width: 100%;
            position: relative;
        }

        /* Static Background */
        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('SupaReportsBG.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 5;
        }

        /* Very subtle overlay for better glass effect */
        .background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.15);
            z-index: 6;
        }

        /* Main Container with Three Side-by-Side Panels */
        .viewport {
            position: relative;
            z-index: 100;
            height: 100vh;
            width: 100%;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .panels-container {
            display: grid;
            grid-template-columns: 405px 700px 405px 900px 1200px;
            grid-auto-flow: column;
            height: calc(100vh - 11rem);
            gap: 2rem;
            padding: 2rem 30px 1rem 60px;
            margin-top: calc(6rem + 80px);
            overflow-x: scroll;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: none;
            transform: scale(0.95);
            transform-origin: top left;
            position: relative;
            top: 0;
            min-height: 0;
            max-height: calc(100vh - 11rem);
        }

        /* Hide horizontal scrollbar completely */
        .panels-container::-webkit-scrollbar {
            display: none;
        }

        /* For Firefox */
        .panels-container {
            scrollbar-width: none;
        }

        /* For IE/Edge */
        .panels-container {
            -ms-overflow-style: none;
        }

        /* Footer Styling */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            z-index: 100;
            font-size: 0.75rem;
            font-weight: 600;
            color: #2d5016;
            letter-spacing: 0.02em;
        }

        /* Individual Panel Styling */
        .panel {
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            padding: 0;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(30px) saturate(140%);
            -webkit-backdrop-filter: blur(30px) saturate(140%);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15),
                        0 0 0 1px rgba(255, 255, 255, 0.2) inset,
                        0 4px 16px rgba(255, 255, 255, 0.1) inset;
            width: 100%;
            height: 100%;
            padding: 1.7rem;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: rgba(217, 70, 239, 0.6) rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
        }

        /* Frosted glass gradient overlay */
        .glass-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            border-radius: 0;
            pointer-events: none;
        }

        .glass-panel::-webkit-scrollbar {
            width: 6px;
        }

        .glass-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 0;
        }

        .glass-panel::-webkit-scrollbar-thumb {
            background: rgba(217, 70, 239, 0.6);
            border-radius: 0;
        }

        .glass-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(217, 70, 239, 0.8);
        }

        /* Panel Headers */
        .panel-header {
            text-align: left;
            margin: 0 1.7rem 1.7rem 1.7rem;
            padding-top: 0;
            padding-bottom: 1rem;
            border-bottom: 2px solid #d946ef;
            flex-shrink: 0;
            min-height: auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .panel-title {
            font-family: 'Funnel Display', sans-serif;
            font-size: 1.3rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #d946ef 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            padding: 0;
        }

        .panel-subtitle {
            color: var(--text-secondary);
            font-size: 0.61rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        /* Compact header for side panels */
        .panel-header.compact {
            min-height: auto;
            justify-content: flex-start;
        }

        .panel-header.compact .panel-title {
            font-size: 1.3rem;
            background: linear-gradient(135deg, #d946ef 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            padding: 0;
        }

        .panel-header.compact .panel-subtitle {
            font-size: 0.54rem;
        }

        /* Form Styling */
        .form-section {
            margin-bottom: 1.7rem;
            flex-shrink: 0;
        }

        /* Ensure form content doesn't overflow */
        form {
            flex-shrink: 0;
        }

        .form-section-title {
            font-size: 0.87rem;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 1.28rem;
            display: flex;
            align-items: center;
            gap: 0.64rem;
        }

        .form-section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--accent-gold);
            border-radius: 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            position: relative;
            margin-bottom: 0.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 0.75rem;
            margin-top: 0.25rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.77rem;
            letter-spacing: 0.02em;
        }

        .required::after {
            content: " *";
            color: var(--accent-gold);
        }

        input[type="text"],
        input[type="date"],
        input[type="file"],
        textarea {
            width: 100%;
            padding: 0.85rem;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 0;
            color: var(--text-primary);
            font-size: 0.69rem;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.75);
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 2px rgba(217, 70, 239, 0.3);
        }

        input::placeholder,
        textarea::placeholder {
            color: rgba(26, 40, 50, 0.4);
            font-style: italic;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            max-width: 100%;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .help-text {
            font-size: 0.72rem;
            color: var(--text-secondary);
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            line-height: 1.5;
        }

        /* Button Styling */
        .btn-primary {
            background: linear-gradient(135deg, #d946ef 0%, #d946ef 50%, #d946ef 100%);
            color: #ffffff;
            padding: 0.85rem 1.7rem;
            border: none;
            border-radius: 0;
            font-size: 0.72rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            box-shadow: 0 4px 16px rgba(217, 70, 239, 0.4);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 0;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(217, 70, 239, 0.6);
            background: linear-gradient(135deg, #d946ef 0%, #e879f9 50%, #d946ef 100%);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Progress State */
        .progress-container {
            display: none;
            text-align: center;
            padding: 3rem;
            flex-shrink: 0;
        }

        .progress-container.active {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(217, 70, 239, 0.2);
            border-top-color: var(--accent-gold);
            border-radius: 0;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-text {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(217, 70, 239, 0.2);
            border-radius: 0;
            overflow: hidden;
            border: 1px solid rgba(217, 70, 239, 0.3);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #d946ef 0%, #d946ef 50%, #e879f9 100%);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(217, 70, 239, 0.5);
        }

        .progress-timer {
            margin-top: 1rem;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.05em;
        }

        /* Results Content Container */
        #resultsContent {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Results Styling */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(217, 70, 239, 0.3);
            flex-shrink: 0;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .results-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .export-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-download {
            background: rgba(217, 70, 239, 0.2);
            color: var(--accent-gold);
            border: 1px solid var(--accent-gold);
            padding: 0.7rem 1.5rem;
            border-radius: 0;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-download:hover {
            background: rgba(217, 70, 239, 0.3);
            transform: translateY(-2px);
        }

        .section-card {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 0;
            padding: 1.7rem;
            margin-bottom: 1.28rem;
            transition: all 0.3s ease;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }

        .section-card:hover {
            background: rgba(255, 255, 255, 0.65);
            border-color: rgba(217, 70, 239, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: var(--accent-gold);
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-transform: capitalize;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-title::before {
            content: '‚óÜ';
            font-size: 1rem;
        }

        .subsection {
            margin-bottom: 1.5rem;
        }

        .subsection-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.9;
        }

        .subsection ul {
            list-style: none;
        }

        .subsection li {
            padding: 0.6rem 0 0.6rem 1.5rem;
            position: relative;
            line-height: 1.6;
            color: var(--text-secondary);
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .subsection li::before {
            content: "‚Üí";
            color: var(--accent-gold);
            position: absolute;
            left: 0;
            font-weight: 700;
        }

        .bonus-section {
            background: linear-gradient(135deg, rgba(217, 70, 239, 0.1) 0%, rgba(217, 70, 239, 0.05) 100%);
            border: 2px solid var(--accent-gold);
        }

        .bonus-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0;
            border-left: 3px solid var(--accent-gold);
        }

        .bonus-item strong {
            color: #000000;
            display: block;
            margin-bottom: 0.5rem;
        }

        /* Error Styling */
        .error-container {
            display: none;
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid rgba(255, 0, 0, 0.4);
            border-radius: 0;
            padding: 2rem;
            margin-top: 2rem;
            flex-shrink: 0;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .error-container.active {
            display: block;
        }

        .error-title {
            color: #ff4444;
            font-weight: 700;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .error-message {
            color: var(--text-secondary);
        }

        /* Script Editor Styling */
        .script-editor {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 0;
            padding: 1rem;
            margin-top: 1rem;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            overflow-wrap: break-word;
            word-wrap: break-word;
            color: var(--text-primary);
        }

        .script-editor[contenteditable="true"] {
            outline: none;
        }

        .script-editor[contenteditable="true"]:focus {
            background: rgba(255, 255, 255, 0.75);
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 2px rgba(217, 70, 239, 0.3);
        }

        .audio-preview {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(217, 70, 239, 0.12);
            border-radius: 0;
            border: 1px solid rgba(217, 70, 239, 0.3);
        }

        .compact-input {
            padding: 0.8rem;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: var(--text-primary);
        }

        .compact-input:focus {
            background: rgba(255, 255, 255, 0.75);
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 2px rgba(217, 70, 239, 0.3);
        }

        .compact-btn {
            padding: 0.85rem 1.5rem;
            font-size: 0.9rem;
        }

        /* Two-column layout for panel 4 */
        .panel-content-wrapper {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            height: 100%;
        }

        .panel-left-column {
            overflow-y: auto;
            padding-right: 1rem;
        }

        .panel-right-column {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding-left: 1rem;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Logo / Header */
        .logo {
            position: fixed;
            top: 50px;
            left: 60px;
            height: 6rem;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: 1rem;
            z-index: 99999;
            font-size: 3.3rem;
            font-weight: 800;
            color: #FFFFFF;
            letter-spacing: -0.02em;
            pointer-events: auto;
        }

        .logo-icon {
            height: 5rem;
            width: auto;
        }

        .logo-title {
            font-family: 'Rethink Sans', sans-serif;
            font-size: 3.3rem;
            font-weight: 700;
            color: #FFFFFF;
            letter-spacing: -0.02em;
        }

        .logo-subtitle {
            font-size: 0.6rem;
            font-weight: 400;
            color: #FFFFFF;
            letter-spacing: 0.05em;
            margin-top: 0.2rem;
            opacity: 0.95;
        }

        /* User Profile Section */
        .user-profile {
            position: fixed;
            top: 62px;
            left: 590px;
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 99999;
            pointer-events: auto;
            min-width: 200px;
            overflow: visible;
        }

        /* Online Avatars Container */
        .online-avatars {
            display: flex;
            align-items: center;
            position: relative;
            margin-right: 1rem;
            overflow: visible;
            min-width: fit-content;
        }

        /* Individual Avatar */
        .user-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d946ef 0%, #7c3aed 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.375rem;
            color: #FFFFFF;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.9);
            flex-shrink: 0;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        /* Stacked avatars - each subsequent avatar overlaps the previous */
        .user-avatar:not(:first-child) {
            margin-left: -20px;
        }

        /* Hover effect for individual avatars */
        .user-avatar:hover {
            transform: translateY(-4px) scale(1.05);
            z-index: 10;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* Avatar with custom profile picture */
        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Tooltip for avatars */
        .user-avatar::after {
            content: attr(data-username);
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .user-avatar:hover::after {
            opacity: 1;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
            color: #FFFFFF;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .user-name {
            font-size: 1.19rem;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        .user-stats {
            font-size: 0.875rem;
            font-weight: 500;
            opacity: 0.9;
            display: flex;
            gap: 1rem;
        }

        .user-stat {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .user-stat-icon {
            font-size: 1rem;
        }

        .user-profile:hover {
            cursor: pointer;
        }

        /* Profile Dropdown Menu */
        .profile-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            min-width: 280px;
            overflow: hidden;
            display: none;
            z-index: 100000;
        }

        .profile-dropdown.active {
            display: block;
        }

        .dropdown-item {
            padding: 0.9rem 1.2rem;
            color: #1a2832;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 0.9rem;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(217, 70, 239, 0.1);
        }

        .dropdown-item-icon {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .dropdown-divider {
            height: 1px;
            background: rgba(0, 0, 0, 0.1);
            margin: 0.25rem 0;
        }

        .dropdown-section-title {
            padding: 0.6rem 1.2rem;
            font-size: 0.75rem;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Sign In Button (when not authenticated) */
        .sign-in-button {
            position: fixed;
            top: 50px;
            right: 60px;
            z-index: 99999;
            background: linear-gradient(135deg, #d946ef 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 0.9rem 2rem;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(217, 70, 239, 0.4);
            transition: all 0.3s;
            display: none;
        }

        .sign-in-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(217, 70, 239, 0.5);
        }

        /* Settings Button */
        .settings-button {
            position: fixed;
            top: 120px;
            right: 60px;
            z-index: 99999;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-button:hover {
            transform: translateY(-2px) rotate(90deg);
            box-shadow: 0 6px 20px rgba(217, 70, 239, 0.4);
            background: rgba(217, 70, 239, 0.2);
            border-color: #d946ef;
        }

        /* Quote Ticker */
        .quote-ticker {
            position: fixed;
            top: 50px;
            right: 220px;
            width: 320px;
            height: 120px;
            z-index: 99998;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            display: none;
        }

        .ticker-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .ticker-content {
            animation: tickerScroll 60s linear;
            animation-iteration-count: 1;
            animation-fill-mode: forwards;
        }

        @keyframes tickerScroll {
            /* First cycle: Quote 1 */
            0%, 8.33% {
                transform: translateY(0);
            }
            /* First cycle: Updates 1 */
            16.66%, 25% {
                transform: translateY(-120px);
            }
            /* Second cycle: Quote 2 */
            33.33%, 41.66% {
                transform: translateY(-240px);
            }
            /* Second cycle: Updates 2 */
            50%, 58.33% {
                transform: translateY(-360px);
            }
            /* Third cycle: Quote 3 */
            66.66%, 75% {
                transform: translateY(-480px);
            }
            /* Third cycle: Updates 3 */
            83.33%, 100% {
                transform: translateY(-600px);
            }
        }

        .ticker-item {
            height: 120px;
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .ticker-quote {
            color: #4b5563;
            font-size: 0.85rem;
            line-height: 1.4;
            font-weight: 500;
            margin-bottom: 8px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .ticker-author {
            color: rgba(75, 85, 99, 0.8);
            font-size: 0.75rem;
            font-style: italic;
            margin-bottom: 6px;
        }

        .ticker-source {
            color: rgba(75, 85, 99, 0.6);
            font-size: 0.7rem;
        }

        .ticker-updates {
            height: 120px;
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .update-title {
            color: #d946ef;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .update-item {
            color: rgba(75, 85, 99, 0.9);
            font-size: 0.75rem;
            line-height: 1.6;
            margin-bottom: 4px;
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999999;
        }

        .login-modal.active {
            display: flex;
        }

        .login-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 16px 64px rgba(0, 0, 0, 0.3);
            padding: 2.5rem;
            max-width: 420px;
            width: 90%;
        }

        .login-modal-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-modal-title {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #d946ef 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .login-modal-subtitle {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .login-input {
            padding: 0.9rem 1.2rem;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
            transition: border 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: #d946ef;
            box-shadow: 0 0 0 3px rgba(217, 70, 239, 0.1);
        }

        .login-button {
            background: linear-gradient(135deg, #d946ef 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(217, 70, 239, 0.4);
        }

        .login-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-divider {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
            color: #6b7280;
            font-size: 0.85rem;
        }

        .login-divider::before,
        .login-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: rgba(0, 0, 0, 0.1);
        }

        .login-divider::before {
            left: 0;
        }

        .login-divider::after {
            right: 0;
        }

        .social-login-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .social-login-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 0.85rem;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .social-login-button:hover {
            background: #f9fafb;
            border-color: #d946ef;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #1a2832;
        }

        /* Auth Tabs */
        .auth-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: rgba(0, 0, 0, 0.05);
            padding: 0.25rem;
            border-radius: 10px;
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: transparent;
            color: #6b7280;
            font-weight: 600;
            font-size: 0.95rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: white;
            color: #d946ef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Auth Error/Success Messages */
        .auth-error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: #f44336;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            text-align: center;
        }

        .auth-success {
            background: rgba(217, 70, 239, 0.1);
            border: 1px solid rgba(217, 70, 239, 0.3);
            color: #d946ef;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            text-align: center;
        }

        .auth-note {
            text-align: center;
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: -0.5rem;
        }

        /* Logo background removed to prevent covering header elements */

        /* Video Modal Styles */
        .video-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .video-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-modal-content {
            position: relative;
            width: 90%;
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
        }

        .video-modal-close {
            position: absolute;
            top: -10px;
            right: 0;
            color: #fff;
            font-size: 3rem;
            font-weight: 300;
            cursor: pointer;
            z-index: 10001;
            line-height: 1;
            padding: 0 1rem;
            transition: all 0.3s ease;
        }

        .video-modal-close:hover {
            color: var(--accent-gold);
            transform: scale(1.1);
        }

        /* Voice Selection Modal Styles */
        .voice-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .voice-item:hover {
            border-color: #d946ef;
            background: rgba(217, 70, 239, 0.05);
            transform: translateX(4px);
        }

        .voice-item-info {
            flex: 1;
        }

        .voice-item-name {
            font-weight: 600;
            font-size: 1rem;
            color: #1a2832;
            margin-bottom: 0.25rem;
        }

        .voice-item-id {
            font-size: 0.8rem;
            color: #6b7280;
            font-family: 'Courier New', monospace;
        }

        .voice-item-category {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: rgba(217, 70, 239, 0.1);
            color: #d946ef;
            font-size: 0.75rem;
            border-radius: 4px;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .voice-item-labels {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 114, 128, 0.4);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .logo {
                padding: 0 1.5rem;
                font-size: 1.65rem;
                height: 4rem;
                top: 50px;
            }

            .logo-title {
                font-size: 1.65rem;
            }

            .logo-subtitle {
                font-size: 0.5rem;
            }

            .user-profile {
                top: 10px;
                right: 10px;
                padding: 0.5rem 0.75rem;
                gap: 0.5rem;
            }

            .user-avatar {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }

            .user-name {
                font-size: 0.8rem;
            }

            .user-stats {
                font-size: 0.6rem;
                gap: 0.5rem;
                flex-direction: column;
            }

            .user-stat-icon {
                font-size: 0.7rem;
            }

            .panels-container {
                grid-template-columns: 1fr;
                padding: 1.7rem 10px 1.7rem 10px;
                gap: 1.7rem;
                margin-top: 4rem;
                height: calc(100vh - 4rem);
                transform: scale(0.85);
                transform-origin: top left;
            }

            .panel {
                height: auto;
                min-height: 50vh;
            }

            .glass-panel {
                padding: 1.28rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .panel-header {
                min-height: auto;
            }

            .panel-title {
                font-size: 1.28rem;
            }

            .panel-header.compact {
                min-height: auto;
            }

            .panel-header.compact .panel-title {
                font-size: 1.1rem;
            }

            .form-section-title {
                font-size: 0.85rem;
            }

            .video-modal-content {
                width: 95%;
                padding: 0.85rem;
            }

            .video-modal-close {
                font-size: 2.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="background"></div>
    <div class="logo">
        <img src="/assets/SR-logo-icon.png" alt="SupaReports Icon" class="logo-icon">
        <div class="logo-title">SupaReports</div>
    </div>

    <!-- User Profile Section -->
    <div class="user-profile" id="userProfile" onclick="toggleProfileDropdown()" style="display: none;">
        <!-- Online Users Avatars (Stacked) -->
        <div class="online-avatars" id="onlineAvatars">
            <!-- Avatars will be dynamically added here -->
        </div>
        <div class="user-info">
            <div class="user-name" id="userName">Lindile Ndube</div>
            <div class="user-stats">
                <div class="user-stat">
                    <span class="user-stat-icon">üìä</span>
                    <span id="reportCount">23</span> <span id="reportLabel">reports</span>
                </div>
                <div class="user-stat">
                    <span class="user-stat-icon">üïí</span>
                    Last: <span id="lastLogin">Today, 2:34 PM</span>
                </div>
            </div>
        </div>

        <!-- Profile Dropdown -->
        <div class="profile-dropdown" id="profileDropdown">
            <div class="dropdown-item" onclick="event.stopPropagation(); showProfileSettings()">
                <span class="dropdown-item-icon">‚öôÔ∏è</span>
                Account Settings
            </div>
            <div class="dropdown-item" onclick="event.stopPropagation(); showEmailManagement()">
                <span class="dropdown-item-icon">üìß</span>
                Manage Email Access
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-section-title">Connected Accounts</div>
            <div class="dropdown-item" onclick="event.stopPropagation(); connectGoogleAccount()">
                <span class="dropdown-item-icon">üîó</span>
                Connect Google Account
            </div>
            <div class="dropdown-item" id="googleAccountStatus" style="display: none; opacity: 0.7; cursor: default;">
                <span class="dropdown-item-icon">‚úì</span>
                <span id="connectedGoogleEmail">google@example.com</span>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="event.stopPropagation(); signOut()">
                <span class="dropdown-item-icon">üö™</span>
                Sign Out
            </div>
        </div>
    </div>

    <!-- Sign In / Logout Button -->
    <button class="sign-in-button" id="signInButton" onclick="handleAuthButtonClick()">Sign In</button>

    <!-- Settings Button -->
    <button class="settings-button" onclick="openSettingsModal()" title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="28" height="28">
            <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
        </svg>
    </button>

    <!-- Quote Ticker (positioned between logout and settings buttons) -->
    <div class="quote-ticker" id="quoteTicker">
        <div class="ticker-container">
            <div class="ticker-content" id="tickerContent">
                <!-- First cycle: Quote -->
                <div class="ticker-item">
                    <div class="ticker-quote" id="quoteText">Loading quote...</div>
                    <div class="ticker-author" id="quoteAuthor"></div>
                    <div class="ticker-source">Source: <span id="quoteSource">BrainyQuote</span></div>
                </div>
                <!-- First cycle: Updates -->
                <div class="ticker-updates">
                    <div class="update-title">üì± Software Updates</div>
                    <div class="update-item">‚úì Report counter real-time updates</div>
                    <div class="update-item">‚úì Quote of the day ticker</div>
                    <div class="update-item">‚úì Email SMTP fallback mechanism</div>
                </div>
                <!-- Second cycle: Quote (duplicate) -->
                <div class="ticker-item">
                    <div class="ticker-quote" id="quoteText2"></div>
                    <div class="ticker-author" id="quoteAuthor2"></div>
                    <div class="ticker-source">Source: <span id="quoteSource2"></span></div>
                </div>
                <!-- Second cycle: Updates -->
                <div class="ticker-updates">
                    <div class="update-title">üì± Software Updates</div>
                    <div class="update-item">‚úì Report counter real-time updates</div>
                    <div class="update-item">‚úì Quote of the day ticker</div>
                    <div class="update-item">‚úì Email SMTP fallback mechanism</div>
                </div>
                <!-- Third cycle: Quote (duplicate) -->
                <div class="ticker-item">
                    <div class="ticker-quote" id="quoteText3"></div>
                    <div class="ticker-author" id="quoteAuthor3"></div>
                    <div class="ticker-source">Source: <span id="quoteSource3"></span></div>
                </div>
                <!-- Third cycle: Updates -->
                <div class="ticker-updates">
                    <div class="update-title">üì± Software Updates</div>
                    <div class="update-item">‚úì Report counter real-time updates</div>
                    <div class="update-item">‚úì Quote of the day ticker</div>
                    <div class="update-item">‚úì Email SMTP fallback mechanism</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication Modal (Login/Signup) -->
    <div class="login-modal" id="authModal">
        <div class="login-modal-content" style="position: relative;">
            <button class="modal-close" onclick="closeAuthModal()">√ó</button>

            <!-- Tab Switcher -->
            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab" onclick="switchAuthTab('login')">Sign In</button>
                <button class="auth-tab" id="signupTab" onclick="switchAuthTab('signup')">Sign Up</button>
            </div>

            <!-- Login Form -->
            <div id="loginFormContainer" class="auth-form-container">
                <div class="login-modal-header">
                    <div class="login-modal-title">Welcome Back</div>
                    <div class="login-modal-subtitle">Sign in to access your dashboard</div>
                </div>

                <form class="login-form" onsubmit="handleLogin(event)">
                    <input type="email" id="loginEmail" class="login-input" placeholder="Email address" required>
                    <input type="password" id="loginPassword" class="login-input" placeholder="Password" required>
                    <div style="text-align: right; margin-top: -8px; margin-bottom: 12px;">
                        <a href="#" onclick="openForgotPasswordModal(event)" style="color: #d946ef; font-size: 0.85rem; text-decoration: none;">Forgot Password?</a>
                    </div>
                    <div id="loginError" class="auth-error" style="display: none;"></div>
                    <button type="submit" class="login-button" id="loginSubmitButton">Sign In</button>
                </form>
            </div>

            <!-- Signup Form -->
            <div id="signupFormContainer" class="auth-form-container" style="display: none;">
                <div class="login-modal-header">
                    <div class="login-modal-title">Create Account</div>
                    <div class="login-modal-subtitle">Get started with Supa Reports</div>
                </div>

                <form class="login-form" onsubmit="handleSignup(event)">
                    <input type="text" id="signupUsername" class="login-input" placeholder="Username (optional)">
                    <input type="email" id="signupEmail" class="login-input" placeholder="Email address" required>
                    <input type="password" id="signupPassword" class="login-input" placeholder="Password (min 8 characters)" required minlength="8">
                    <input type="password" id="signupConfirmPassword" class="login-input" placeholder="Confirm password" required minlength="8">
                    <div id="signupError" class="auth-error" style="display: none;"></div>
                    <div id="signupSuccess" class="auth-success" style="display: none;"></div>
                    <button type="submit" class="login-button" id="signupSubmitButton">Create Account</button>
                    <div class="auth-note">
                        By signing up, you agree to receive a verification email.
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="login-modal" id="forgotPasswordModal">
        <div class="login-modal-content" style="position: relative; max-width: 450px;">
            <button class="modal-close" onclick="closeForgotPasswordModal()">√ó</button>

            <div class="login-modal-header">
                <div class="login-modal-title">Reset Password</div>
                <div class="login-modal-subtitle">Enter your email to receive reset instructions</div>
            </div>

            <form class="login-form" onsubmit="handleRequestReset(event)">
                <input type="email" id="resetEmail" class="login-input" placeholder="Email address" required>
                <div id="resetRequestError" class="auth-error" style="display: none;"></div>
                <div id="resetRequestSuccess" class="auth-success" style="display: none;"></div>
                <button type="submit" class="login-button" id="resetRequestButton">Send Reset Link</button>
                <div style="text-align: center; margin-top: 16px;">
                    <a href="#" onclick="backToLogin(event)" style="color: #888; font-size: 0.85rem; text-decoration: none;">Back to Sign In</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Reset Password Modal (with token) -->
    <div class="login-modal" id="resetPasswordModal">
        <div class="login-modal-content" style="position: relative; max-width: 450px;">
            <button class="modal-close" onclick="closeResetPasswordModal()">√ó</button>

            <div class="login-modal-header">
                <div class="login-modal-title">Create New Password</div>
                <div class="login-modal-subtitle">Enter your new password below</div>
            </div>

            <form class="login-form" onsubmit="handleResetPassword(event)">
                <input type="hidden" id="resetToken" value="">
                <input type="password" id="newPassword" class="login-input" placeholder="New password (min 8 characters)" required minlength="8">
                <input type="password" id="confirmNewPassword" class="login-input" placeholder="Confirm new password" required minlength="8">
                <div id="resetPasswordError" class="auth-error" style="display: none;"></div>
                <div id="resetPasswordSuccess" class="auth-success" style="display: none;"></div>
                <button type="submit" class="login-button" id="resetPasswordButton">Reset Password</button>
            </form>
        </div>
    </div>

    <!-- Wordsmith Prompt Templates Modal -->
    <div class="login-modal" id="wordsmithModal">
        <div class="login-modal-content" style="position: relative; max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <button class="modal-close" onclick="closeWordsmithModal()">√ó</button>

            <!-- Fixed Header -->
            <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); z-index: 100; flex-shrink: 0;">
                <div class="login-modal-header" style="margin-bottom: 0;">
                    <div class="login-modal-title">‚ú® WORDSMITH - Prompt Templates</div>
                    <div class="login-modal-subtitle">Copy and customize these templates for your scripts and emails</div>
                </div>

                <!-- Template Type Tabs -->
                <div style="display: flex; gap: 1rem; padding: 0 1.5rem; border-bottom: 2px solid rgba(217, 70, 239, 0.3);">
                    <button onclick="switchWordsmithTab('scripts')" id="scriptsTab" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #d946ef 0%, #7c3aed 100%); color: white; border: none; font-weight: 600; cursor: pointer; border-radius: 4px 4px 0 0;">
                        Report Scripts
                    </button>
                    <button onclick="switchWordsmithTab('emails')" id="emailsTab" style="padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.5); color: #333; border: none; font-weight: 600; cursor: pointer; border-radius: 4px 4px 0 0;">
                        Email Drafting
                    </button>
                </div>
            </div>

            <!-- Scrollable Content Area -->
            <div style="padding: 1.5rem; overflow-y: auto; flex: 1;">

                <!-- Script Templates -->
                <div id="scriptsTemplates" class="wordsmith-tab-content">
                    <div class="wordsmith-template" data-style="professional-script">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h3 style="color: #d946ef; margin: 0;">Professional Script</h3>
                            <button onclick="copyTemplate('professional-script')" style="background: #d946ef; color: white; border: none; padding: 0.5rem 1rem; font-size: 0.85rem; cursor: pointer; border-radius: 4px;">Copy</button>
                        </div>
                        <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 4px; font-size: 0.85rem; line-height: 1.6;">
                            <strong>Prompt:</strong> Write a professional report script for a marketing campaign.<br><br>
                            <strong>Character:</strong> {{Character name or role, e.g., Senior Marketing Analyst}}<br>
                            <strong>Setting:</strong> {{Business presentation / client review / boardroom summary}}<br>
                            <strong>Tone:</strong> Polished, concise, authoritative.<br>
                            <strong>Audio Length:</strong> {{Duration in seconds or minutes}}<br>
                            <strong>Key Topics:</strong> {{Insert campaign focus areas ‚Äì audience, media, creative, performance, recommendations}}<br>
                            <strong>Goal:</strong> Deliver clear, data-backed insights with a confident, executive-level delivery.
                        </div>
                    </div>

                    <div class="wordsmith-template" data-style="humorous-script" style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h3 style="color: #d946ef; margin: 0;">Humorous Script</h3>
                            <button onclick="copyTemplate('humorous-script')" style="background: #d946ef; color: white; border: none; padding: 0.5rem 1rem; font-size: 0.85rem; cursor: pointer; border-radius: 4px;">Copy</button>
                        </div>
                        <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 4px; font-size: 0.85rem; line-height: 1.6;">
                            <strong>Prompt:</strong> Create a humorous report script that explains campaign performance in a light, relatable way.<br><br>
                            <strong>Character:</strong> {{Comedic host / funny analyst / satirical narrator}}<br>
                            <strong>Setting:</strong> {{Casual team debrief / podcast / YouTube show}}<br>
                            <strong>Tone:</strong> Witty, playful, clever wordplay.<br>
                            <strong>Audio Length:</strong> {{Duration}}<br>
                            <strong>Key Topics:</strong> {{Insert performance data, audience insights, creative wins, quirky facts}}<br>
                            <strong>Goal:</strong> Make complex data fun and memorable while still delivering accurate insights.
                        </div>
                    </div>

                    <div class="wordsmith-template" data-style="energetic-script" style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h3 style="color: #d946ef; margin: 0;">Energetic Script</h3>
                            <button onclick="copyTemplate('energetic-script')" style="background: #d946ef; color: white; border: none; padding: 0.5rem 1rem; font-size: 0.85rem; cursor: pointer; border-radius: 4px;">Copy</button>
                        </div>
                        <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 4px; font-size: 0.85rem; line-height: 1.6;">
                            <strong>Prompt:</strong> Generate an energetic and fast-paced report script that feels like a live show or hype recap.<br><br>
                            <strong>Character:</strong> {{Energetic presenter / campaign host}}<br>
                            <strong>Setting:</strong> {{Game show / stage presentation / internal highlight reel}}<br>
                            <strong>Tone:</strong> Upbeat, motivational, high tempo.<br>
                            <strong>Audio Length:</strong> {{Duration}}<br>
                            <strong>Key Topics:</strong> {{Performance highlights, audience engagement, standout results, next actions}}<br>
                            <strong>Goal:</strong> Build excitement around achievements and energize the audience to act.
                        </div>
                    </div>

                    <div class="wordsmith-template" data-style="inspirational-script" style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h3 style="color: #d946ef; margin: 0;">Inspirational Script</h3>
                            <button onclick="copyTemplate('inspirational-script')" style="background: #d946ef; color: white; border: none; padding: 0.5rem 1rem; font-size: 0.85rem; cursor: pointer; border-radius: 4px;">Copy</button>
                        </div>
                        <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 4px; font-size: 0.85rem; line-height: 1.6;">
                            <strong>Prompt:</strong> Write an inspirational report script that motivates teams by highlighting progress, learnings, and future opportunities.<br><br>
                            <strong>Character:</strong> {{Mentor / visionary leader / narrator}}<br>
                            <strong>Setting:</strong> {{Townhall / internal summit / campaign close-out}}<br>
                            <strong>Tone:</strong> Reflective, empowering, warm.<br>
                            <strong>Audio Length:</strong> {{Duration}}<br>
                            <strong>Key Topics:</strong> {{Key learnings, cultural impact, vision, team success}}<br>
                            <strong>Goal:</strong> Inspire teams to keep improving and align around the brand vision.
                        </div>
                    </div>

                    <div class="wordsmith-template" data-style="conversational-script" style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h3 style="color: #d946ef; margin: 0;">Conversational Script</h3>
                            <button onclick="copyTemplate('conversational-script')" style="background: #d946ef; color: white; border: none; padding: 0.5rem 1rem; font-size: 0.85rem; cursor: pointer; border-radius: 4px;">Copy</button>
                        </div>
                        <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 4px; font-size: 0.85rem; line-height: 1.6;">
                            <strong>Prompt:</strong> Write a casual, conversational report script that sounds like a friendly chat between team members.<br><br>
                            <strong>Character:</strong> {{Peer / brand strategist / data storyteller}}<br>
                            <strong>Setting:</strong> {{Team debrief / coffee chat / casual presentation}}<br>
                            <strong>Tone:</strong> Relaxed, natural, human.<br>
                            <strong>Audio Length:</strong> {{Duration}}<br>
                            <strong>Key Topics:</strong> {{Campaign wins, challenges, learning moments, audience reactions}}<br>
                            <strong>Goal:</strong> Make the report approachable and engaging, like sharing insights in real-time.
                        </div>
                    </div>
                </div>

                <!-- Email Templates -->
                <div id="emailsTemplates" class="wordsmith-tab-content" style="display: none;">
                    <div class="wordsmith-template" data-style="professional-email">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h3 style="color: #d946ef; margin: 0;">Professional Email</h3>
                            <button onclick="copyTemplate('professional-email')" style="background: #d946ef; color: white; border: none; padding: 0.5rem 1rem; font-size: 0.85rem; cursor: pointer; border-radius: 4px;">Copy</button>
                        </div>
                        <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 4px; font-size: 0.85rem; line-height: 1.6;">
                            <strong>Prompt:</strong> Draft a professional marketing email.<br><br>
                            <strong>Hook Headline:</strong> {{Insert engaging but formal headline}}<br>
                            <strong>Intro Paragraph:</strong> Summarize the message concisely and professionally, establishing credibility immediately.<br>
                            <strong>Key Bullet Points:</strong><br>
                            1. {{Main update or insight}}<br>
                            2. {{Supporting data or reasoning}}<br>
                            3. {{Recommended next action}}<br>
                            4. {{Call-to-engagement or follow-up detail}}<br>
                            5. {{Optional value statement}}<br>
                            <strong>Closing Message:</strong> Polite, confident sign-off encouraging response or collaboration.
                        </div>
                    </div>

                    <div class="wordsmith-template" data-style="humorous-email" style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h3 style="color: #d946ef; margin: 0;">Humorous Email</h3>
                            <button onclick="copyTemplate('humorous-email')" style="background: #d946ef; color: white; border: none; padding: 0.5rem 1rem; font-size: 0.85rem; cursor: pointer; border-radius: 4px;">Copy</button>
                        </div>
                        <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 4px; font-size: 0.85rem; line-height: 1.6;">
                            <strong>Prompt:</strong> Create a fun and witty marketing email that makes readers smile while delivering value.<br><br>
                            <strong>Hook Headline:</strong> {{Playful, pun-based subject line}}<br>
                            <strong>Intro Paragraph:</strong> Use humor to disarm the reader and make the topic approachable.<br>
                            <strong>Key Bullet Points:</strong><br>
                            1. {{Funny insight or data twist}}<br>
                            2. {{Light commentary on industry trends}}<br>
                            3. {{Relevant campaign highlight}}<br>
                            4. {{Engaging call-to-action}}<br>
                            5. {{Cheeky closing teaser}}<br>
                            <strong>Closing Message:</strong> End with humor that ties back to the brand's personality.
                        </div>
                    </div>

                    <div class="wordsmith-template" data-style="energetic-email" style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h3 style="color: #d946ef; margin: 0;">Energetic Email</h3>
                            <button onclick="copyTemplate('energetic-email')" style="background: #d946ef; color: white; border: none; padding: 0.5rem 1rem; font-size: 0.85rem; cursor: pointer; border-radius: 4px;">Copy</button>
                        </div>
                        <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 4px; font-size: 0.85rem; line-height: 1.6;">
                            <strong>Prompt:</strong> Write an energetic and punchy email that grabs attention instantly.<br><br>
                            <strong>Hook Headline:</strong> {{Exciting, action-oriented subject line}}<br>
                            <strong>Intro Paragraph:</strong> Get straight to the momentum ‚Äî highlight urgency, wins, or opportunities.<br>
                            <strong>Key Bullet Points:</strong><br>
                            1. {{Main win or update}}<br>
                            2. {{Performance stat or proof point}}<br>
                            3. {{Next action or opportunity}}<br>
                            4. {{Motivational statement}}<br>
                            5. {{Engagement CTA}}<br>
                            <strong>Closing Message:</strong> End with enthusiasm and a strong brand-positive tone.
                        </div>
                    </div>

                    <div class="wordsmith-template" data-style="inspirational-email" style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h3 style="color: #d946ef; margin: 0;">Inspirational Email</h3>
                            <button onclick="copyTemplate('inspirational-email')" style="background: #d946ef; color: white; border: none; padding: 0.5rem 1rem; font-size: 0.85rem; cursor: pointer; border-radius: 4px;">Copy</button>
                        </div>
                        <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 4px; font-size: 0.85rem; line-height: 1.6;">
                            <strong>Prompt:</strong> Write an inspirational marketing email that uplifts and connects emotionally.<br><br>
                            <strong>Hook Headline:</strong> {{Hopeful or visionary subject line}}<br>
                            <strong>Intro Paragraph:</strong> Reflect on a positive achievement or learning moment to set the mood.<br>
                            <strong>Key Bullet Points:</strong><br>
                            1. {{Core theme or message}}<br>
                            2. {{Quote or statistic that inspires}}<br>
                            3. {{Team or brand impact}}<br>
                            4. {{Future direction or next step}}<br>
                            5. {{Encouraging CTA}}<br>
                            <strong>Closing Message:</strong> Warm, motivational closing that reinforces optimism and collaboration.
                        </div>
                    </div>

                    <div class="wordsmith-template" data-style="conversational-email" style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h3 style="color: #d946ef; margin: 0;">Conversational Email</h3>
                            <button onclick="copyTemplate('conversational-email')" style="background: #d946ef; color: white; border: none; padding: 0.5rem 1rem; font-size: 0.85rem; cursor: pointer; border-radius: 4px;">Copy</button>
                        </div>
                        <div style="background: rgba(255,255,255,0.7); padding: 1rem; border-radius: 4px; font-size: 0.85rem; line-height: 1.6;">
                            <strong>Prompt:</strong> Write a friendly, conversational email that feels personal and approachable.<br><br>
                            <strong>Hook Headline:</strong> {{Simple, human subject line}}<br>
                            <strong>Intro Paragraph:</strong> Start with a relatable statement or question that feels like a one-on-one note.<br>
                            <strong>Key Bullet Points:</strong><br>
                            1. {{Main topic summary}}<br>
                            2. {{Interesting observation or insight}}<br>
                            3. {{Action step or link}}<br>
                            4. {{Invitation to discuss or share}}<br>
                            5. {{Casual encouragement or sign-off cue}}<br>
                            <strong>Closing Message:</strong> End naturally ‚Äî friendly tone with gratitude or anticipation for reply.
                        </div>
                    </div>
                </div>

                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(217, 70, 239, 0.1); border-radius: 4px; font-size: 0.85rem; color: #333;">
                    <strong>üí° Usage Notes:</strong><br>
                    ‚Ä¢ Replace all placeholders (e.g., {{Character}}, {{Key Topics}}) before use.<br>
                    ‚Ä¢ Each template is compatible with Azi's SupaReport analysis engine.<br>
                    ‚Ä¢ Click "Copy" buttons to copy templates to clipboard.
                </div>
            </div>
        </div>
    </div>

    <!-- Live Sessions Counter -->
    <div id="liveSessionsCounter" style="display: none; position: fixed; top: 150px; left: 60px; font-size: 0.9rem; font-weight: 600; color: #FFFFFF; z-index: 99998;">
        üü¢ Live Sessions: <span id="liveSessionsCount">0</span>
    </div>

    <div class="viewport">
        <div class="panels-container" id="panelsContainer">
            <!-- Panel 1: Input Form -->
            <div class="panel" data-panel="0">
                <div class="glass-panel" style="display: flex; flex-direction: column; padding: 0;">
                    <div class="panel-header compact" style="position: sticky; top: 0; z-index: 10; background: transparent; padding: 1.7rem 0 1rem 0; margin: 0 1.7rem 0 1.7rem; border-bottom: 2px solid #d946ef;">
                        <div class="panel-title">CONFIGURE YOUR REPORT</div>
                    </div>

                    <form id="analysisForm" enctype="multipart/form-data" style="flex: 1; overflow-y: auto; padding: 20px 1.7rem 1.7rem 1.7rem;">
                        <div class="form-section" style="margin-top: 0;">
                            <div class="form-section-title">Core Information</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="required">Brand Name</label>
                                    <input type="text" name="brand" required placeholder="e.g., Acme Corp">
                                </div>
                                <div class="form-group">
                                    <label class="required">Market</label>
                                    <input type="text" name="market" required placeholder="e.g., South Africa">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="required">Start Date</label>
                                    <input type="date" name="start_date" required>
                                </div>
                                <div class="form-group">
                                    <label class="required">End Date</label>
                                    <input type="date" name="end_date" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="required">Objective</label>
                                    <input type="text" name="objective" required placeholder="e.g., Brand Awareness">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">Competitive Context</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Competitors</label>
                                    <input type="text" name="competitors" placeholder="e.g., Competitor A, Competitor B">
                                    <div class="help-text">Comma-separated list of competitor names</div>
                                </div>
                                <div class="form-group">
                                    <label>Competitor URLs</label>
                                    <input type="text" name="competitor_urls" placeholder="Comma-separated URLs">
                                    <div class="help-text">Social handles or websites</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">Data Upload (Primary Source)</div>
                            <div class="form-group full-width">
                                <label>Data File <span style="color: #d946ef; font-weight: 600;">*Recommended</span></label>
                                <input type="file" name="data_file" accept=".csv,.xlsx,.xls,.pdf,.txt,.json">
                                <div class="help-text">üìä Upload campaign data export (CSV, XLSX, or PDF) from your analytics platform, OR provide dashboard links below</div>
                            </div>
                            <div class="form-group full-width" style="margin-top: 1.5rem;">
                                <label>Dashboard Links</label>
                                <input type="text" name="dashboard_links" placeholder="Comma-separated dashboard URLs (e.g., Looker Studio)" autocomplete="off">
                                <div class="help-text">üåê <strong>Live Dashboard Scraping:</strong> We'll automatically extract data from your dashboard links using browser automation.</div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">Research Context (Optional)</div>
                            <div class="form-group full-width">
                                <label>Research URLs</label>
                                <input type="text" name="research_urls" placeholder="Comma-separated URLs">
                                <div class="help-text">External research or competitor pages for context</div>
                            </div>
                            <div class="form-group full-width">
                                <label>Hypotheses</label>
                                <input type="text" name="hypotheses" placeholder="Comma-separated hypotheses">
                                <div class="help-text">Key questions or assumptions to test</div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary">Run Analysis</button>
                    </form>

                    <div class="progress-container" id="progressContainer">
                        <div class="progress-text">Analyzing your data...</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                        <div class="progress-timer" id="progressTimer">Time elapsed: 0:00</div>
                    </div>

                    <div class="completion-message" id="completionMessage" style="display: none; text-align: center; padding: 1rem; margin-top: 1rem; background: rgba(217, 70, 239, 0.1); border: 1px solid rgba(217, 70, 239, 0.3); border-radius: 0;">
                        <div style="color: #d946ef; font-weight: 600; font-size: 0.9rem;">‚úì Analysis completed in <span id="completionTime">0:00</span></div>
                    </div>

                    <div class="error-container" id="errorContainer">
                        <div class="error-title">Analysis Error</div>
                        <div class="error-message" id="errorMessage"></div>
                    </div>
                </div>
            </div>

            <!-- Panel 2: Report -->
            <div class="panel" data-panel="1">
                <div class="glass-panel" id="reportPanel">
                    <div class="panel-header">
                        <div class="panel-title">YOUR SUPA REPORT</div>
                    </div>

                    <div id="resultsContent">
                        <p style="text-align: center; color: var(--text-secondary); padding: 4rem 2rem;">
                            Configure your report to view Your Supa Report here.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Panel 3: Script & Audio Functions -->
            <div class="panel" data-panel="2">
                <div class="glass-panel" style="display: flex; flex-direction: column; padding: 0;">
                    <div class="panel-header compact" style="position: sticky; top: 0; z-index: 10; background: transparent; padding: 1.7rem 0 1rem 0; margin: 0 1.7rem 0 1.7rem; border-bottom: 2px solid #d946ef;">
                        <div class="panel-title">SPARK THE MAGIC</div>
                    </div>

                    <div style="flex: 1; overflow-y: auto; padding: 20px 1.7rem 1.7rem 1.7rem;">
                    <!-- Chat Input to Modify Report -->
                    <div class="form-section">
                        <div class="form-section-title">Modify Report</div>
                        <div class="form-group">
                            <textarea id="chatInput" class="compact-input" placeholder="Ask AI to make changes to the report..." rows="3"></textarea>
                        </div>
                        <button class="btn-primary compact-btn" id="sendChatBtn" onclick="sendChatMessage(event)" style="margin-top: 0.75rem;">Send</button>
                    </div>

                    <!-- Wordsmith Button -->
                    <div style="margin-top: 1.5rem;">
                        <button onclick="openWordsmithModal()" style="background: linear-gradient(135deg, #d946ef 0%, #7c3aed 100%); color: white; border: none; padding: 0.75rem 1.5rem; font-weight: 600; font-size: 0.9rem; cursor: pointer; width: 100%; border-radius: 4px; transition: all 0.3s ease;">
                            ‚ú® WORDSMITH - Prompt Templates
                        </button>
                    </div>

                    <!-- Create Script Function -->
                    <div class="form-section" style="margin-top: 1.5rem;">
                        <div class="form-section-title">Script Creation</div>
                        <div class="form-group">
                            <textarea id="scriptPrompt" class="compact-input" placeholder="e.g., Create a 60-second video script highlighting the top 3 insights for Instagram Reels..." rows="3"></textarea>
                            <div class="help-text">Describe what kind of script you want AI to generate from the report</div>
                        </div>
                        <button class="btn-primary compact-btn" onclick="createScript()" style="margin-top: 0.75rem;">Generate Script</button>

                        <!-- Script Editor -->
                        <div id="scriptContainer" style="display: none; margin-top: 1rem;">
                            <label style="margin-bottom: 0.5rem; display: block;">Edit Script</label>
                            <div id="scriptEditor" class="script-editor" contenteditable="true">
                                Your script will appear here...
                            </div>
                        </div>
                    </div>

                    <!-- ElevenLabs TTS Section -->
                    <div class="form-section" id="ttsSection" style="margin-top: 2rem; display: none;">
                        <div class="form-section-title">Text-to-Speech</div>
                        <div class="form-group">
                            <label class="required">Voice ID</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="voiceId" class="compact-input" placeholder="Enter ElevenLabs Voice ID" style="flex: 1;">
                                <button class="btn-secondary compact-btn" onclick="openVoiceModal()" style="margin: 0; white-space: nowrap;">Browse Voices</button>
                            </div>
                            <div class="help-text">Your ElevenLabs voice identifier</div>
                        </div>
                        <button class="btn-primary compact-btn" onclick="generateAudio()" style="margin-top: 0.75rem;">Generate Audio</button>

                        <!-- Audio Preview -->
                        <div id="audioPreview" style="display: none;" class="audio-preview">
                            <label style="margin-bottom: 0.5rem; display: block; font-weight: 600;">Audio Preview</label>
                            <audio id="audioPlayer" controls style="width: 100%; margin-top: 0.5rem;">
                                <source id="audioSource" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                            <button class="btn-download" onclick="pushAudioToVideo()" style="margin-top: 1rem; width: 100%;">Push to Video ‚Üí</button>
                        </div>
                    </div>
                    </div>
                </div>
            </div>

            <!-- Panel 4: Lipsync Video Generation -->
            <div class="panel" data-panel="3">
                <div class="glass-panel" style="display: flex; flex-direction: column; padding: 0;">
                    <div class="panel-header compact" style="position: sticky; top: 0; z-index: 10; background: transparent; padding: 1.7rem 0 1rem 0; margin: 0 1.7rem 0 1.7rem; border-bottom: 2px solid #d946ef;">
                        <div class="panel-title">BRING TO LIFE</div>
                    </div>

                    <div class="panel-content-wrapper" style="flex: 1; overflow-y: auto; padding: 20px 1.7rem 1.7rem 1.7rem;">
                        <!-- Left Column: Input Functions -->
                        <div class="panel-left-column">
                            <!-- Image Upload -->
                            <div class="form-section">
                                <div class="form-section-title">Upload Image</div>
                                <div class="form-group">
                                    <label>Select Image</label>
                                    <input type="file" id="lipsyncImage" class="compact-input" accept="image/*">
                                    <div class="help-text">Upload an image for lip-sync animation</div>
                                </div>
                                <!-- Image Preview -->
                                <div id="imagePreview" style="display: none; margin-top: 1rem; position: relative;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <label style="margin: 0;">Preview</label>
                                        <button onclick="removeImageAttachment()" style="background: rgba(255, 0, 0, 0.2); border: 1px solid rgba(255, 0, 0, 0.4); color: #ff4444; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.8rem; border-radius: 0;">‚úï Remove</button>
                                    </div>
                                    <img id="previewImg" style="width: 100%; max-height: 200px; object-fit: contain; border-radius: 0; border: 1px solid rgba(255, 255, 255, 0.4);">
                                </div>
                            </div>

                            <!-- Manual Video Upload (for timeout cases) -->
                            <div class="form-section" style="margin-top: 2rem;">
                                <div class="form-section-title">Or Upload Finished Video</div>
                                <div class="form-group">
                                    <label>Select Video File</label>
                                    <input type="file" id="manualVideoUpload" class="compact-input" accept="video/*">
                                    <div class="help-text">Upload a pre-rendered video (if generation timed out)</div>
                                </div>
                                <!-- Video Attachment Indicator -->
                                <div id="videoAttachmentIndicator" style="display: none; margin-top: 1rem; padding: 0.75rem; background: rgba(217, 70, 239, 0.1); border: 1px solid rgba(217, 70, 239, 0.3); position: relative;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="font-size: 1.2rem;">üé¨</span>
                                            <div>
                                                <div style="color: #d946ef; font-weight: 600; font-size: 0.85rem;" id="videoAttachmentName">Video attached</div>
                                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.75rem;" id="videoAttachmentSize"></div>
                                            </div>
                                        </div>
                                        <button onclick="removeVideoAttachment()" style="background: rgba(255, 0, 0, 0.2); border: 1px solid rgba(255, 0, 0, 0.4); color: #ff4444; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.8rem; border-radius: 0;">‚úï Remove</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Audio Status -->
                            <div class="form-section" style="margin-top: 2rem;">
                                <div id="audioStatusIndicator" style="padding: 0.75rem; background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3); text-align: center; color: #ff4444; font-size: 0.85rem; font-weight: 600;">
                                    ‚ö†Ô∏è No audio attached
                                </div>
                            </div>

                            <!-- Video Prompt -->
                            <div class="form-section" style="margin-top: 2rem;">
                                <div class="form-section-title">Video Settings</div>
                                <div class="form-group">
                                    <label>Video Prompt (Optional)</label>
                                    <textarea id="videoPrompt" class="compact-input" placeholder="e.g., Make the expression friendly and engaging..." rows="3"></textarea>
                                    <div class="help-text">Describe how you want the video to look</div>
                                </div>
                            </div>

                            <!-- Generate Button -->
                            <div class="form-section" style="margin-top: 2rem;">
                                <button class="btn-primary compact-btn" id="generateVideoBtn" onclick="generateLipsyncVideo()" style="width: 100%;">Bring To Life</button>
                            </div>

                            <!-- Progress Indicator -->
                            <div class="progress-container" id="videoProgressContainer" style="margin-top: 1.5rem;">
                                <div class="progress-text" id="videoProgressText">Uploading files...</div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" id="videoProgressBar"></div>
                                </div>
                                <div class="progress-timer" id="videoProgressTimer">Time elapsed: 0:00</div>
                            </div>

                            <div class="completion-message" id="videoCompletionMessage" style="display: none; text-align: center; padding: 1rem; margin-top: 1rem; background: rgba(217, 70, 239, 0.1); border: 1px solid rgba(217, 70, 239, 0.3); border-radius: 0;">
                                <div style="color: #d946ef; font-weight: 600; font-size: 0.9rem;">‚úì Video generated in <span id="videoCompletionTime">0:00</span></div>
                            </div>
                        </div>

                        <!-- Right Column: Video Preview -->
                        <div class="panel-right-column">
                            <div class="form-section-title">Video Preview</div>
                            <div id="videoPreviewSection" style="margin-top: 1rem;">
                                <div style="background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 0; padding: 1rem; position: relative;">
                                    <div style="max-height: 600px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #000;">
                                        <video
                                            id="lipsyncVideoPlayer"
                                            controls
                                            preload="auto"
                                            playsinline
                                            style="width: 100%; max-height: 600px; border-radius: 0; display: none; object-fit: contain;">
                                            <source id="lipsyncVideoSource" type="video/mp4">
                                            Your browser does not support the video element.
                                        </video>
                                    </div>
                                    <div id="videoPlaceholder" style="width: 100%; aspect-ratio: 16/9; background: rgba(0,0,0,0.1); border-radius: 0; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 0.9rem;">
                                        Video will appear here
                                    </div>
                                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
                                        <button class="btn-download" onclick="expandVideo()" style="flex: 1; display: none;" id="expandVideoBtn">
                                            <span style="font-size: 1.1rem;">‚õ∂</span> Expand
                                        </button>
                                        <button class="btn-download" onclick="downloadLipsyncVideo()" style="flex: 1; display: none;" id="downloadVideoBtn">Download Video</button>
                                        <button class="btn-download" onclick="pushToEmail()" style="flex: 1; display: none; background: linear-gradient(135deg, #d946ef 0%, #7c3aed 100%); color: white; border-color: #d946ef;" id="pushToEmailBtn">Push to Email ‚Üí</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel 5: Email Template -->
            <div class="panel" data-panel="4">
                <div class="glass-panel" style="display: flex; flex-direction: column; padding: 0;">
                    <div class="panel-header compact" style="position: sticky; top: 0; z-index: 10; background: transparent; padding: 1.7rem 0 1rem 0; margin: 0 1.7rem 0 1.7rem; border-bottom: 2px solid #d946ef;">
                        <div class="panel-title">SPREAD THE JOY</div>
                    </div>

                    <div style="display: grid; grid-template-columns: 450px 1fr; gap: 2rem; flex: 1; min-height: 0; padding: 20px 1.7rem 1.7rem 1.7rem;">
                        <!-- Left Column: Email Editor Controls -->
                        <div style="overflow-y: auto; padding-right: 1rem; height: 100%;">
                            <div class="form-section">
                                <div class="form-section-title">Brand Colors</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                    <div class="form-group">
                                        <label>Primary Color</label>
                                        <input type="color" id="emailPrimaryColor" class="compact-input" value="#d946ef" onchange="updateEmailPreview()" style="height: 50px; cursor: pointer;">
                                    </div>
                                    <div class="form-group">
                                        <label>Accent Color</label>
                                        <input type="color" id="emailAccentColor" class="compact-input" value="#7c3aed" onchange="updateEmailPreview()" style="height: 50px; cursor: pointer;">
                                    </div>
                                </div>
                            </div>

                            <div class="form-section" style="margin-top: 1.5rem;">
                                <div class="form-section-title">Email Content</div>
                                <div class="form-group">
                                    <label>Headline</label>
                                    <input type="text" id="emailHeadline" class="compact-input" placeholder="e.g., Your Campaign Performance Highlights" value="Your Campaign Performance Highlights">
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label>Intro Paragraph</label>
                                    <textarea id="emailIntro" class="compact-input" rows="3" placeholder="Short exciting intro paragraph...">We're excited to share the latest performance insights from your campaign! Check out the highlights below.</textarea>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label>Key Bullet Points</label>
                                    <textarea id="emailBullets" class="compact-input" rows="4" placeholder="One bullet point per line...">üìä Campaign achieved 150% of engagement targets
üéØ Audience reach expanded by 45% in key demographics
üöÄ Video content drove 3x higher conversion rates</textarea>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label>Closing Message</label>
                                    <textarea id="emailClosing" class="compact-input" rows="2" placeholder="Closing message...">Let's discuss how to build on this momentum for your next campaign.</textarea>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label>Video Link URL</label>
                                    <input type="text" id="emailVideoLink" class="compact-input" placeholder="https://yourvideo.com/link" value="">
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label>Header Background Image (optional)</label>
                                    <input type="file" id="headerImageUpload" class="compact-input" accept="image/*">
                                    <div class="help-text">Recommended: 600√ó200px. Will display behind headline.</div>
                                    <div id="headerImagePreview" style="display: none; margin-top: 0.5rem; position: relative;">
                                        <img id="headerImagePreviewImg" style="width: 100%; max-height: 100px; object-fit: cover; border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.4);">
                                        <button onclick="removeHeaderImage()" style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(255, 0, 0, 0.8); border: 1px solid rgba(255, 0, 0, 1); color: white; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.8rem; border-radius: 4px;">‚úï Remove</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Send Email Section -->
                            <div class="form-section" style="margin-top: 1.5rem;">
                                <div class="form-section-title">Send Email</div>
                                <div class="form-group">
                                    <label>From Email</label>
                                    <input type="email" id="senderEmail" class="compact-input" placeholder="your@email.com">
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label>To Email(s)</label>
                                    <input type="text" id="recipientEmails" class="compact-input" placeholder="recipient@email.com, another@email.com">
                                    <div class="help-text">Separate multiple emails with commas</div>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label>Email Subject</label>
                                    <input type="text" id="emailSubject" class="compact-input" placeholder="Campaign Performance Report" value="Campaign Performance Report">
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem; padding: 1rem 0; flex-direction: column;">
                                <button class="btn-primary compact-btn" onclick="sendEmail()" style="width: 100%; background: linear-gradient(135deg, #d946ef 0%, #7c3aed 100%); color: white; border-color: #d946ef; font-weight: 700;">üìß Send Email</button>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn-primary compact-btn" onclick="updateEmailPreview()" style="flex: 1;">Update Preview</button>
                                    <button class="btn-download" onclick="copyEmailHTML()" style="flex: 1;">Copy HTML</button>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Email Preview -->
                        <div style="overflow-y: auto; border-left: 1px solid rgba(255, 255, 255, 0.3); padding-left: 2rem; height: 100%;">
                            <div class="form-section-title" style="margin-bottom: 1rem; position: sticky; top: 0; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 0.5rem 0; z-index: 5;">Email Preview</div>
                            <div id="emailPreview" style="background: white; border: 1px solid rgba(0,0,0,0.1); padding: 2rem; font-family: Arial, sans-serif; border-radius: 8px;">
                                <!-- Email template will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <div class="footer">
            Powered by SupaChat
        </div>
    </div>

    <!-- Video Expand Modal -->
    <div id="videoModal" class="video-modal">
        <div class="video-modal-content">
            <span class="video-modal-close" onclick="closeVideoModal()">&times;</span>
            <video
                id="modalVideoPlayer"
                controls
                preload="none"
                playsinline
                style="width: 100%; max-height: 90vh; object-fit: contain;">
                <source id="modalVideoSource" src="" type="video/mp4">
                Your browser does not support the video element.
            </video>
        </div>
    </div>

    <!-- Voice Selection Modal -->
    <div class="login-modal" id="voiceModal">
        <div class="login-modal-content" style="position: relative; max-width: 700px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <button class="modal-close" onclick="closeVoiceModal()">√ó</button>

            <div class="login-modal-header">
                <div class="login-modal-title">Select a Voice</div>
                <div class="login-modal-subtitle">Choose from your ElevenLabs voices</div>
            </div>

            <div id="voiceLoadingMessage" style="text-align: center; padding: 2rem; color: #6b7280;">
                Loading voices...
            </div>

            <div id="voiceErrorMessage" style="display: none; text-align: center; padding: 2rem; color: #dc2626;">
                Failed to load voices. Please check your API key.
            </div>

            <div id="voiceListContainer" style="display: none; overflow-y: auto; max-height: 500px;">
                <div id="voiceList" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <!-- Voice items will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="login-modal" id="settingsModal">
        <div class="login-modal-content" style="position: relative; max-width: 600px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column;">
            <button class="modal-close" onclick="closeSettingsModal()">√ó</button>

            <div class="login-modal-header">
                <div class="login-modal-title">Settings</div>
                <div class="login-modal-subtitle">Customize your experience</div>
            </div>

            <div style="overflow-y: auto; padding: 0 0.5rem;">
                <div class="form-section">
                    <div class="form-section-title">Profile Settings</div>

                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" id="settingsDisplayName" class="compact-input" placeholder="Enter your display name">
                        <div class="help-text">This name will be shown in the header</div>
                    </div>

                    <div class="form-group">
                        <label>Email Send Address</label>
                        <input type="email" id="settingsEmailAddress" class="compact-input" placeholder="your@email.com">
                        <div class="help-text">Default email address for sending reports</div>
                    </div>

                    <div class="form-group">
                        <label>Profile Avatar</label>
                        <input type="file" id="settingsAvatarUpload" accept="image/*" style="margin-bottom: 0.5rem;">
                        <div class="help-text">Upload a profile picture (max 2MB)</div>
                        <div id="avatarPreview" style="margin-top: 1rem; display: none; position: relative; width: fit-content;">
                            <img id="avatarPreviewImg" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #d946ef;">
                            <button onclick="clearAvatar()" style="position: absolute; top: -8px; right: -8px; width: 28px; height: 28px; border-radius: 50%; background: #dc2626; color: white; border: 2px solid white; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center; padding: 0;">√ó</button>
                        </div>
                    </div>
                </div>

                <div class="form-section" style="margin-top: 1.5rem;">
                    <div class="form-section-title">Appearance</div>

                    <div class="form-group">
                        <label>Background Image</label>
                        <input type="file" id="settingsBackgroundUpload" accept="image/*" style="margin-bottom: 0.5rem;">
                        <div class="help-text">Upload a custom background image (recommended: 1920x1080px)</div>
                        <div id="backgroundPreview" style="margin-top: 1rem; display: none; position: relative; width: fit-content;">
                            <img id="backgroundPreviewImg" style="width: 100%; max-width: 400px; border-radius: 8px; border: 2px solid #d946ef;">
                            <button onclick="clearBackground()" style="position: absolute; top: -8px; right: -8px; width: 32px; height: 32px; border-radius: 50%; background: #dc2626; color: white; border: 2px solid white; cursor: pointer; font-size: 18px; font-weight: bold; display: flex; align-items: center; justify-content: center; padding: 0;">√ó</button>
                        </div>
                        <button class="btn-download" onclick="resetBackground()" style="margin-top: 0.75rem;">Reset to Default</button>
                    </div>
                </div>

                <!-- Admin Panel (only visible to admins) -->
                <div class="form-section" id="adminPanelSection" style="margin-top: 1.5rem; display: none;">
                    <div class="form-section-title">üëë Admin Panel</div>

                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong>Pending Approvals</strong>
                            <button class="btn-download" onclick="refreshPendingUsers()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">üîÑ Refresh</button>
                        </div>
                        <div id="pendingUsersList" style="margin-top: 1rem;">
                            <div style="text-align: center; color: #999; padding: 1rem;">Loading...</div>
                        </div>
                    </div>

                    <button class="btn-download" onclick="viewAllUsers()" style="width: 100%; margin-top: 0.5rem;">
                        üë• View All Users
                    </button>
                </div>

                <div class="form-section" style="margin-top: 1.5rem; margin-bottom: 1rem;">
                    <button class="btn-primary compact-btn" onclick="saveSettings()" style="width: 100%;">üíæ Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // Authentication State
        // ============================================================================
        let currentUser = null;
        let isAuthenticated = false;

        // ============================================================================
        // Authentication Functions
        // ============================================================================

        // Check authentication status on page load
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/session');
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    isAuthenticated = true;
                    updateUIForAuthenticatedUser(data);
                } else {
                    showSignInButton();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                showSignInButton();
            }
        }

        // Refresh user stats (call after generating reports/videos/etc)
        async function refreshUserStats() {
            try {
                const response = await fetch('/api/auth/session');
                if (response.ok) {
                    const data = await response.json();
                    // Update only the stats without refreshing entire UI
                    document.getElementById('reportCount').textContent = data.stats.reports;
                }
            } catch (error) {
                console.error('Failed to refresh stats:', error);
            }
        }

        // Load and display quote of the day
        async function loadQuoteOfTheDay() {
            try {
                const response = await fetch('/api/quote-of-the-day');
                if (response.ok) {
                    const data = await response.json();

                    // Update quote elements for all three cycles
                    const quoteText = `"${data.quote}"`;
                    const authorText = `‚Äî ${data.author}`;
                    const sourceText = data.source;

                    // First cycle
                    document.getElementById('quoteText').textContent = quoteText;
                    document.getElementById('quoteAuthor').textContent = authorText;
                    document.getElementById('quoteSource').textContent = sourceText;

                    // Second cycle
                    document.getElementById('quoteText2').textContent = quoteText;
                    document.getElementById('quoteAuthor2').textContent = authorText;
                    document.getElementById('quoteSource2').textContent = sourceText;

                    // Third cycle
                    document.getElementById('quoteText3').textContent = quoteText;
                    document.getElementById('quoteAuthor3').textContent = authorText;
                    document.getElementById('quoteSource3').textContent = sourceText;

                    // Show ticker
                    const quoteTicker = document.getElementById('quoteTicker');
                    quoteTicker.style.display = 'block';

                    // Restart animation by removing and re-adding class
                    const tickerContent = document.getElementById('tickerContent');
                    tickerContent.style.animation = 'none';
                    setTimeout(() => {
                        tickerContent.style.animation = 'tickerScroll 60s linear 1 forwards';
                    }, 10);
                } else {
                    console.error('Failed to load quote');
                }
            } catch (error) {
                console.error('Error loading quote:', error);
            }
        }

        // Update UI for authenticated user
        function updateUIForAuthenticatedUser(data) {
            // Change button to Logout
            const signInButton = document.getElementById('signInButton');
            signInButton.textContent = 'Logout';
            signInButton.style.display = 'block';

            const userProfile = document.getElementById('userProfile');
            userProfile.style.display = 'flex';

            // Update user info
            document.getElementById('userName').textContent = data.user.username || data.user.email.split('@')[0];
            document.getElementById('reportCount').textContent = data.stats.reports;

            // Update report label based on admin status
            const reportLabel = document.getElementById('reportLabel');
            if (reportLabel) {
                reportLabel.textContent = data.user.is_admin ? 'total reports' : 'my reports';
            }

            // Immediately show current user's avatar as placeholder
            const avatarsContainer = document.getElementById('onlineAvatars');
            if (avatarsContainer) {
                avatarsContainer.innerHTML = ''; // Clear any existing
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.setAttribute('data-username', data.user.username || data.user.email);

                if (data.user.profile_picture) {
                    const img = document.createElement('img');
                    img.src = data.user.profile_picture;
                    img.alt = data.user.username || data.user.email;
                    avatar.appendChild(img);
                } else {
                    avatar.textContent = (data.user.username || data.user.email).substring(0, 2).toUpperCase();
                }

                avatarsContainer.appendChild(avatar);
            }

            // Show live sessions counter
            document.getElementById('liveSessionsCount').textContent = data.global_stats.live_sessions;
            document.getElementById('liveSessionsCounter').style.display = 'block';

            // Update last login
            if (data.user.last_login) {
                const lastLogin = new Date(data.user.last_login);
                document.getElementById('lastLogin').textContent = lastLogin.toLocaleString();
            }

            // Load quote of the day ticker
            loadQuoteOfTheDay();

            // Start refreshing online users (will replace placeholder with full list)
            startOnlineUsersRefresh();
        }

        // Show sign in button and open login modal
        function showSignInButton() {
            const signInButton = document.getElementById('signInButton');
            signInButton.textContent = 'Sign In';
            signInButton.style.display = 'block';
            document.getElementById('userProfile').style.display = 'none';
            document.getElementById('liveSessionsCounter').style.display = 'none';

            // Stop online users refresh if running
            stopOnlineUsersRefresh();

            // Automatically open login modal for unauthenticated users
            openLoginModal();
        }

        // Handle auth button click
        function handleAuthButtonClick() {
            const signInButton = document.getElementById('signInButton');
            if (signInButton.textContent === 'Logout') {
                signOut();
            } else {
                openLoginModal();
            }
        }

        // Open login modal
        function openLoginModal() {
            document.getElementById('authModal').classList.add('active');
            switchAuthTab('login');
        }

        // Close auth modal
        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            // Clear forms
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('signupUsername').value = '';
            document.getElementById('signupEmail').value = '';
            document.getElementById('signupPassword').value = '';
            document.getElementById('signupConfirmPassword').value = '';
            // Hide error messages
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('signupError').style.display = 'none';
            document.getElementById('signupSuccess').style.display = 'none';
        }

        // Switch between login and signup tabs
        function switchAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const signupTab = document.getElementById('signupTab');
            const loginContainer = document.getElementById('loginFormContainer');
            const signupContainer = document.getElementById('signupFormContainer');

            if (tab === 'login') {
                loginTab.classList.add('active');
                signupTab.classList.remove('active');
                loginContainer.style.display = 'block';
                signupContainer.style.display = 'none';
            } else {
                loginTab.classList.remove('active');
                signupTab.classList.add('active');
                loginContainer.style.display = 'none';
                signupContainer.style.display = 'block';
            }

            // Clear error messages when switching
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('signupError').style.display = 'none';
            document.getElementById('signupSuccess').style.display = 'none';
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const submitButton = document.getElementById('loginSubmitButton');
            const errorDiv = document.getElementById('loginError');

            submitButton.disabled = true;
            submitButton.textContent = 'Signing in...';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Success - reload page to load authenticated state
                    window.location.reload();
                } else {
                    // Show error
                    errorDiv.textContent = data.error || data.message || 'Login failed';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Sign In';
            }
        }

        // Handle signup form submission
        async function handleSignup(event) {
            event.preventDefault();

            const username = document.getElementById('signupUsername').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const submitButton = document.getElementById('signupSubmitButton');
            const errorDiv = document.getElementById('signupError');
            const successDiv = document.getElementById('signupSuccess');

            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // Validate password match
            if (password !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Creating account...';

            try {
                const response = await fetch('/api/auth/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Success - show success message
                    successDiv.innerHTML = `
                        <strong>Account created!</strong><br>
                        Please check your email (${email}) to verify your account.
                    `;
                    successDiv.style.display = 'block';

                    // Clear form
                    document.getElementById('signupUsername').value = '';
                    document.getElementById('signupEmail').value = '';
                    document.getElementById('signupPassword').value = '';
                    document.getElementById('signupConfirmPassword').value = '';

                    // Switch to login tab after 3 seconds
                    setTimeout(() => {
                        switchAuthTab('login');
                    }, 3000);
                } else {
                    // Show error
                    errorDiv.textContent = data.error || 'Signup failed';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Create Account';
            }
        }

        // Handle logout
        async function signOut() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                // Reload page to show logged out state
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
                // Still reload on error
                window.location.reload();
            }
        }

        // ============================================================================
        // Password Reset Functions
        // ============================================================================

        function openForgotPasswordModal(event) {
            if (event) event.preventDefault();
            closeAuthModal();
            document.getElementById('forgotPasswordModal').classList.add('active');
            // Clear form
            document.getElementById('resetEmail').value = '';
            document.getElementById('resetRequestError').style.display = 'none';
            document.getElementById('resetRequestSuccess').style.display = 'none';
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').classList.remove('active');
        }

        function backToLogin(event) {
            if (event) event.preventDefault();
            closeForgotPasswordModal();
            openLoginModal();
        }

        async function handleRequestReset(event) {
            event.preventDefault();

            const email = document.getElementById('resetEmail').value;
            const submitButton = document.getElementById('resetRequestButton');
            const errorDiv = document.getElementById('resetRequestError');
            const successDiv = document.getElementById('resetRequestSuccess');

            submitButton.disabled = true;
            submitButton.textContent = 'Sending...';
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            try {
                const response = await fetch('/api/auth/request-reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (response.ok) {
                    // Show success message
                    successDiv.textContent = data.message;
                    successDiv.style.display = 'block';
                    document.getElementById('resetEmail').value = '';
                } else {
                    // Show error
                    errorDiv.textContent = data.error || 'Failed to send reset email';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Send Reset Link';
            }
        }

        function openResetPasswordModal(token) {
            document.getElementById('resetPasswordModal').classList.add('active');
            document.getElementById('resetToken').value = token;
            // Clear form
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            document.getElementById('resetPasswordError').style.display = 'none';
            document.getElementById('resetPasswordSuccess').style.display = 'none';
        }

        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').classList.remove('active');
        }

        async function handleResetPassword(event) {
            event.preventDefault();

            const token = document.getElementById('resetToken').value;
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            const submitButton = document.getElementById('resetPasswordButton');
            const errorDiv = document.getElementById('resetPasswordError');
            const successDiv = document.getElementById('resetPasswordSuccess');

            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // Validate passwords match
            if (password !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Resetting...';

            try {
                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Show success message
                    successDiv.textContent = data.message;
                    successDiv.style.display = 'block';

                    // Redirect to login after 2 seconds
                    setTimeout(() => {
                        closeResetPasswordModal();
                        openLoginModal();
                    }, 2000);
                } else {
                    // Show error
                    errorDiv.textContent = data.error || 'Failed to reset password';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Reset Password';
            }
        }

        // Check for reset token in URL on page load
        function checkForResetToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('reset_token');

            if (resetToken) {
                // Open reset password modal with token
                openResetPasswordModal(resetToken);
                // Clean up URL without page reload
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // ============================================================================
        // Wordsmith Prompt Templates Functions
        // ============================================================================

        function openWordsmithModal() {
            document.getElementById('wordsmithModal').classList.add('active');
            // Default to scripts tab
            switchWordsmithTab('scripts');
        }

        function closeWordsmithModal() {
            document.getElementById('wordsmithModal').classList.remove('active');
        }

        function switchWordsmithTab(tabName) {
            // Hide all tab contents
            document.getElementById('scriptsTemplates').style.display = 'none';
            document.getElementById('emailsTemplates').style.display = 'none';

            // Reset tab buttons
            document.getElementById('scriptsTab').style.background = 'rgba(255,255,255,0.5)';
            document.getElementById('scriptsTab').style.color = '#333';
            document.getElementById('emailsTab').style.background = 'rgba(255,255,255,0.5)';
            document.getElementById('emailsTab').style.color = '#333';

            // Show selected tab
            if (tabName === 'scripts') {
                document.getElementById('scriptsTemplates').style.display = 'block';
                document.getElementById('scriptsTab').style.background = 'linear-gradient(135deg, #d946ef 0%, #7c3aed 100%)';
                document.getElementById('scriptsTab').style.color = 'white';
            } else if (tabName === 'emails') {
                document.getElementById('emailsTemplates').style.display = 'block';
                document.getElementById('emailsTab').style.background = 'linear-gradient(135deg, #d946ef 0%, #7c3aed 100%)';
                document.getElementById('emailsTab').style.color = 'white';
            }
        }

        function copyTemplate(templateId) {
            // Find the template element
            const templateEl = document.querySelector(`[data-style="${templateId}"]`);
            if (!templateEl) return;

            // Get the template content
            const contentDiv = templateEl.querySelector('div[style*="background: rgba(255,255,255,0.7)"]');
            if (!contentDiv) return;

            // Extract text content (strip HTML)
            const templateText = contentDiv.innerText;

            // Copy to clipboard
            navigator.clipboard.writeText(templateText).then(() => {
                // Show success feedback
                const button = templateEl.querySelector('button');
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.style.background = '#4CAF50';

                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#d946ef';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy template:', err);
                alert('Failed to copy template. Please try manually selecting and copying the text.');
            });
        }

        // ============================================================================
        // Online Users Management
        // ============================================================================

        async function fetchOnlineUsers() {
            try {
                const response = await fetch('/api/auth/online-users', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        renderOnlineUsers(data.users);
                        updateLiveSessionsCount(data.count);
                    }
                }
            } catch (error) {
                console.error('Error fetching online users:', error);
            }
        }

        function renderOnlineUsers(users) {
            const avatarsContainer = document.getElementById('onlineAvatars');
            if (!avatarsContainer) return;

            // Clear existing avatars
            avatarsContainer.innerHTML = '';

            // Limit to first 5 users to avoid overcrowding
            const displayUsers = users.slice(0, 5);

            displayUsers.forEach((user, index) => {
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.setAttribute('data-username', user.username || user.email);
                avatar.setAttribute('data-user-id', user.id);
                avatar.style.zIndex = displayUsers.length - index;

                // Check if user has a profile picture
                if (user.profile_picture && user.profile_picture.startsWith('http')) {
                    const img = document.createElement('img');
                    img.src = user.profile_picture;
                    img.alt = user.username || user.email;
                    avatar.appendChild(img);
                } else {
                    // Use initials
                    avatar.textContent = user.initials;
                }

                avatarsContainer.appendChild(avatar);
            });

            // If more than 5 users, show a "+N" indicator
            if (users.length > 5) {
                const moreAvatar = document.createElement('div');
                moreAvatar.className = 'user-avatar';
                moreAvatar.textContent = `+${users.length - 5}`;
                moreAvatar.setAttribute('data-username', `${users.length - 5} more online`);
                moreAvatar.style.fontSize = '1rem';
                moreAvatar.style.background = 'linear-gradient(135deg, #888 0%, #aaa 100%)';
                avatarsContainer.appendChild(moreAvatar);
            }
        }

        function updateLiveSessionsCount(count) {
            const liveSessionsCounter = document.getElementById('liveSessionsCounter');
            const liveSessionsCount = document.getElementById('liveSessionsCount');

            if (liveSessionsCounter && liveSessionsCount) {
                liveSessionsCount.textContent = count;
                // Only show if there are active sessions
                if (count > 0) {
                    liveSessionsCounter.style.display = 'block';
                } else {
                    liveSessionsCounter.style.display = 'none';
                }
            }
        }

        // Auto-refresh online users every 30 seconds
        let onlineUsersInterval = null;

        function startOnlineUsersRefresh() {
            // Initial fetch
            fetchOnlineUsers();

            // Clear any existing interval
            if (onlineUsersInterval) {
                clearInterval(onlineUsersInterval);
            }

            // Refresh every 30 seconds
            onlineUsersInterval = setInterval(fetchOnlineUsers, 30000);
        }

        function stopOnlineUsersRefresh() {
            if (onlineUsersInterval) {
                clearInterval(onlineUsersInterval);
                onlineUsersInterval = null;
            }
        }

        // ============================================================================
        // Existing Variables
        // ============================================================================
        let currentResults = null;
        let currentScript = null;
        let currentAudioBlob = null;
        let currentVideoUrl = null;
        let progressInterval = null;
        let videoProgressInterval = null;
        let timerInterval = null;
        let videoTimerInterval = null;
        let timerStartTime = null;
        let videoTimerStartTime = null;

        const form = document.getElementById('analysisForm');
        const progressContainer = document.getElementById('progressContainer');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const resultsContent = document.getElementById('resultsContent');
        const progressBar = document.getElementById('progressBar');

        // Timer functions
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            timerStartTime = Date.now();
            const timerElement = document.getElementById('progressTimer');

            // Clear any existing timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
                timerElement.textContent = `Time elapsed: ${formatTime(elapsed)}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function startVideoTimer() {
            videoTimerStartTime = Date.now();
            const timerElement = document.getElementById('videoProgressTimer');

            // Clear any existing timer
            if (videoTimerInterval) {
                clearInterval(videoTimerInterval);
            }

            videoTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - videoTimerStartTime) / 1000);
                timerElement.textContent = `Time elapsed: ${formatTime(elapsed)}`;
            }, 1000);
        }

        function stopVideoTimer() {
            if (videoTimerInterval) {
                clearInterval(videoTimerInterval);
                videoTimerInterval = null;
            }
        }

        // Animate progress bar
        function animateProgressBar() {
            let progress = 0;
            const progressBar = document.getElementById('progressBar');

            // Clear any existing interval
            if (progressInterval) {
                clearInterval(progressInterval);
            }

            // Start from 0
            progressBar.style.width = '0%';

            // Start timer
            startTimer();

            // Animate to 90% over ~30 seconds, slowing down as it approaches 90%
            progressInterval = setInterval(() => {
                if (progress < 90) {
                    // Slow down as we approach 90%
                    const increment = (90 - progress) * 0.05;
                    progress += Math.max(increment, 0.5);
                    progressBar.style.width = Math.min(progress, 90) + '%';
                } else {
                    // Stay at 90% until request completes
                    clearInterval(progressInterval);
                }
            }, 300);
        }

        // Complete progress bar
        function completeProgressBar() {
            const progressBar = document.getElementById('progressBar');
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            progressBar.style.width = '100%';

            // Calculate final time
            const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
            const finalTime = formatTime(elapsed);

            // Stop timer and show completion message
            stopTimer();
            document.getElementById('completionTime').textContent = finalTime;
            document.getElementById('completionMessage').style.display = 'block';
        }

        // Reset progress bar
        function resetProgressBar() {
            const progressBar = document.getElementById('progressBar');
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            progressBar.style.width = '0%';
            stopTimer();
            document.getElementById('progressTimer').textContent = 'Time elapsed: 0:00';
            document.getElementById('completionMessage').style.display = 'none';
        }

        // Animate video progress bar
        function animateVideoProgressBar() {
            let progress = 0;
            const videoProgressBar = document.getElementById('videoProgressBar');

            // Clear any existing interval
            if (videoProgressInterval) {
                clearInterval(videoProgressInterval);
            }

            // Start from 0
            videoProgressBar.style.width = '0%';

            // Start timer
            startVideoTimer();

            // Animate to 85% gradually, speeds up initially then slows down
            videoProgressInterval = setInterval(() => {
                if (progress < 20) {
                    // Fast initial upload (0-20%)
                    progress += 0.8;
                } else if (progress < 85) {
                    // Slower processing (20-85%)
                    const increment = (85 - progress) * 0.01;
                    progress += Math.max(increment, 0.1);
                } else {
                    // Stay at 85% until request completes
                    clearInterval(videoProgressInterval);
                }
                videoProgressBar.style.width = Math.min(progress, 85) + '%';
            }, 500);
        }

        // Complete video progress bar
        function completeVideoProgressBar() {
            const videoProgressBar = document.getElementById('videoProgressBar');
            if (videoProgressInterval) {
                clearInterval(videoProgressInterval);
            }
            videoProgressBar.style.width = '100%';

            // Calculate final time
            const elapsed = Math.floor((Date.now() - videoTimerStartTime) / 1000);
            const finalTime = formatTime(elapsed);

            // Stop timer and show completion message
            stopVideoTimer();
            document.getElementById('videoCompletionTime').textContent = finalTime;
            document.getElementById('videoCompletionMessage').style.display = 'block';
        }

        // Reset video progress bar
        function resetVideoProgressBar() {
            const videoProgressBar = document.getElementById('videoProgressBar');
            if (videoProgressInterval) {
                clearInterval(videoProgressInterval);
            }
            videoProgressBar.style.width = '0%';
            stopVideoTimer();
            document.getElementById('videoProgressTimer').textContent = 'Time elapsed: 0:00';
            document.getElementById('videoCompletionMessage').style.display = 'none';
        }

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            progressContainer.classList.add('active');
            errorContainer.classList.remove('active');
            document.getElementById('completionMessage').style.display = 'none';
            animateProgressBar();

            try {
                const formData = new FormData(form);
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.message || 'Analysis failed');
                }

                if (data.success) {
                    currentResults = data.data;
                    completeProgressBar();

                    // Wait a moment to show 100% before hiding
                    await new Promise(resolve => setTimeout(resolve, 500));

                    renderResults(data.data);

                    // Refresh user stats to update report counter
                    if (isAuthenticated) {
                        await refreshUserStats();
                    }
                } else {
                    throw new Error(data.error || 'Analysis returned no data');
                }

            } catch (error) {
                errorMessage.textContent = error.message;
                errorContainer.classList.add('active');
                resetProgressBar();
            } finally {
                progressContainer.classList.remove('active');
            }
        });

        function renderResults(data) {
            let html = `
                <div class="results-header">
                    <div class="results-title">Analysis Complete</div>
                    <div class="export-buttons">
                        <button class="btn-download" onclick="exportReport('txt')">Export TXT</button>
                        <button class="btn-download" onclick="exportReport('pdf')" style="margin-left: 0.5rem;">Export PDF</button>
                        <button class="btn-download" onclick="exportReport('docx')" style="margin-left: 0.5rem;">Export Word</button>
                    </div>
                </div>
            `;

            const sections = ['audience', 'media', 'creative', 'conversion', 'competitive', 'optimization'];
            sections.forEach(section => {
                if (data[section]) {
                    html += renderSection(section, data[section]);
                }
            });

            if (data.bonus) {
                html += renderBonus(data.bonus);
            }

            resultsContent.innerHTML = html;
        }

        function renderSection(name, section) {
            return `
                <div class="section-card">
                    <h3 class="section-title">${name}</h3>
                    ${renderSubsection('Key Findings', section.key_findings)}
                    ${renderSubsection('Supporting Data', section.supporting_data)}
                    ${renderSubsection('Research Context', section.research_context)}
                    ${renderSubsection('Implications', section.implications)}
                    ${renderSubsection('Actions', section.actions)}
                </div>
            `;
        }

        function renderSubsection(title, items) {
            if (!items || items.length === 0) return '';
            return `
                <div class="subsection">
                    <div class="subsection-title">${title}</div>
                    <ul>
                        ${items.map(item => `<li>${escapeHtml(item)}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function renderBonus(bonus) {
            return `
                <div class="section-card bonus-section">
                    <h3 class="section-title">Bonus Insights</h3>
                    <div class="bonus-item">
                        <strong>One Sentence Summary</strong>
                        ${escapeHtml(bonus.one_sentence)}
                    </div>
                    <div class="bonus-item">
                        <strong>Key Takeaway</strong>
                        ${escapeHtml(bonus.key_takeaway)}
                    </div>
                    <div class="bonus-item">
                        <strong>Unexpected Learning</strong>
                        ${escapeHtml(bonus.unexpected_learning)}
                    </div>
                </div>
            `;
        }

        function downloadJSON() {
            if (!currentResults) {
                alert('No analysis results to download. Please run an analysis first.');
                return;
            }

            const dataStr = JSON.stringify(currentResults, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `supareports-analysis-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Chat function to modify report
        async function sendChatMessage(event) {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();

            if (!message) {
                alert('Please enter a message');
                return;
            }

            if (!currentResults) {
                alert('Please run an analysis first before modifying the report');
                return;
            }

            // Show loading state
            const sendButton = event ? event.target : document.getElementById('sendChatBtn');
            const originalText = sendButton.textContent;
            sendButton.textContent = 'Processing...';
            sendButton.disabled = true;

            try {
                // Call Ollama chat modification endpoint
                const response = await fetch('/api/chat-modify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        current_report: currentResults
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.message || 'Chat modification failed');
                }

                console.log('Received modified report:', data);

                if (data.success && data.report) {
                    // Update the current results with modified report
                    currentResults = data.report;

                    console.log('Updated currentResults:', currentResults);

                    // Re-render the results panel
                    try {
                        renderResults(data.report);
                        console.log('Successfully re-rendered results panel');
                    } catch (renderError) {
                        console.error('Error rendering results:', renderError);
                        throw new Error('Failed to render updated report: ' + renderError.message);
                    }

                    // Clear the chat input
                    chatInput.value = '';

                    // Show success message
                    alert('Report updated successfully!');
                } else {
                    throw new Error('Modification returned no data');
                }

            } catch (error) {
                console.error('Chat modification error:', error);
                alert('Error modifying report: ' + error.message);
            } finally {
                // Restore button state
                sendButton.textContent = originalText;
                sendButton.disabled = false;
            }
        }

        // Create script from report
        async function createScript() {
            const scriptPrompt = document.getElementById('scriptPrompt');
            const prompt = scriptPrompt.value.trim();

            if (!prompt) {
                alert('Please enter a prompt describing what kind of script you want');
                return;
            }

            if (!currentResults) {
                alert('Please run an analysis first before creating a script');
                return;
            }

            // Show loading state
            const generateButton = event ? event.target : document.querySelector('button[onclick="createScript()"]');
            const originalText = generateButton.textContent;
            generateButton.textContent = 'Generating...';
            generateButton.disabled = true;

            try {
                // Call backend to generate script using AI
                const response = await fetch('/api/generate-script', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        report: currentResults
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate script');
                }

                if (data.success && data.script) {
                    // Show the script editor
                    const scriptContainer = document.getElementById('scriptContainer');
                    const scriptEditor = document.getElementById('scriptEditor');
                    const ttsSection = document.getElementById('ttsSection');

                    scriptEditor.textContent = data.script;
                    scriptContainer.style.display = 'block';
                    ttsSection.style.display = 'block';

                    currentScript = data.script;
                } else {
                    throw new Error('No script generated');
                }

            } catch (error) {
                console.error('Script generation error:', error);
                alert('Error generating script: ' + error.message);
            } finally {
                // Restore button state
                generateButton.textContent = originalText;
                generateButton.disabled = false;
            }
        }

        // Generate audio using ElevenLabs API
        async function generateAudio() {
            const voiceId = document.getElementById('voiceId').value.trim();
            const scriptEditor = document.getElementById('scriptEditor');
            const scriptText = scriptEditor.textContent.trim();

            if (!voiceId) {
                alert('Please enter an ElevenLabs Voice ID');
                return;
            }

            if (!scriptText) {
                alert('Please create a script first');
                return;
            }

            try {
                // Call ElevenLabs API
                const response = await fetch('/api/generate-audio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: scriptText,
                        voice_id: voiceId
                    })
                });

                if (!response.ok) {
                    // Try to get the error message from the backend
                    try {
                        const errorData = await response.json();
                        throw new Error(errorData.message || errorData.error || 'Failed to generate audio');
                    } catch (parseError) {
                        throw new Error('Failed to generate audio');
                    }
                }

                // Get audio blob
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);

                // Store audio blob for lipsync video generation
                currentAudioBlob = audioBlob;

                // Show audio preview
                const audioPreview = document.getElementById('audioPreview');
                const audioSource = document.getElementById('audioSource');
                const audioPlayer = document.getElementById('audioPlayer');

                audioSource.src = audioUrl;
                audioPlayer.load();
                audioPreview.style.display = 'block';

                // Update audio status in Bring To Life panel
                updateAudioStatus(true);

            } catch (error) {
                console.error('Audio generation error:', error);
                alert('Error generating audio: ' + error.message);
            }
        }

        // Push audio to video panel
        function pushAudioToVideo() {
            if (!currentAudioBlob) {
                alert('No audio available to push');
                return;
            }

            // Update status indicator
            updateAudioStatus(true);

            // Scroll to the Bring To Life panel
            const bringToLifePanel = document.querySelector('[data-panel="3"]');
            if (bringToLifePanel) {
                bringToLifePanel.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
            }

            // Show confirmation
            alert('Audio ready! Upload an image in the "Bring To Life" panel to create your lipsync video.');
        }

        // Update audio status indicator
        function updateAudioStatus(hasAudio) {
            const statusIndicator = document.getElementById('audioStatusIndicator');
            if (statusIndicator) {
                if (hasAudio) {
                    statusIndicator.style.background = 'rgba(217, 70, 239, 0.15)';
                    statusIndicator.style.borderColor = 'rgba(217, 70, 239, 0.5)';
                    statusIndicator.style.color = '#d946ef';
                    statusIndicator.textContent = '‚úì Audio ready';
                } else {
                    statusIndicator.style.background = 'rgba(255, 0, 0, 0.1)';
                    statusIndicator.style.borderColor = 'rgba(255, 0, 0, 0.3)';
                    statusIndicator.style.color = '#ff4444';
                    statusIndicator.textContent = '‚ö†Ô∏è No audio attached';
                }
            }
        }

        // Export report in different formats
        async function exportReport(format) {
            if (!currentResults) {
                alert('No analysis results to export. Please run an analysis first.');
                return;
            }

            try {
                const endpoint = `/api/export-${format}`;
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        report: currentResults
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Failed to export ${format.toUpperCase()}`);
                }

                // Get the blob and trigger download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // Extract filename from Content-Disposition header if available
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `supareports_analysis.${format}`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = filenameMatch[1].replace(/['"]/g, '');
                    }
                }

                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error(`Export ${format} error:`, error);
                alert(`Error exporting ${format.toUpperCase()}: ` + error.message);
            }
        }

        // Image preview for lipsync
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication status on page load
            checkAuthStatus();

            // Check for password reset token in URL
            checkForResetToken();

            const lipsyncImageInput = document.getElementById('lipsyncImage');
            if (lipsyncImageInput) {
                lipsyncImageInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const previewImg = document.getElementById('previewImg');
                            const imagePreview = document.getElementById('imagePreview');
                            previewImg.src = e.target.result;
                            imagePreview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Manual video upload handler
            const manualVideoInput = document.getElementById('manualVideoUpload');
            if (manualVideoInput) {
                manualVideoInput.addEventListener('change', async function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        console.log('Manual video uploaded:', file.name);

                        // Show video in preview
                        const videoPlayer = document.getElementById('lipsyncVideoPlayer');
                        const videoSource = document.getElementById('lipsyncVideoSource');
                        const videoPlaceholder = document.getElementById('videoPlaceholder');
                        const expandBtn = document.getElementById('expandVideoBtn');
                        const downloadBtn = document.getElementById('downloadVideoBtn');
                        const pushBtn = document.getElementById('pushToEmailBtn');

                        // Create blob URL from uploaded file
                        const videoBlob = new Blob([await file.arrayBuffer()], { type: file.type });
                        const videoBlobUrl = URL.createObjectURL(videoBlob);

                        // Store video URL for download and push to email
                        currentVideoUrl = videoBlobUrl;

                        // Update video source
                        videoSource.src = videoBlobUrl;
                        videoSource.type = file.type || 'video/mp4';
                        videoPlayer.load();

                        // Show video player, hide placeholder
                        videoPlayer.style.display = 'block';
                        videoPlaceholder.style.display = 'none';

                        // Show action buttons
                        expandBtn.style.display = 'block';
                        downloadBtn.style.display = 'block';
                        pushBtn.style.display = 'block';

                        // Show video attachment indicator
                        const indicator = document.getElementById('videoAttachmentIndicator');
                        const nameElement = document.getElementById('videoAttachmentName');
                        const sizeElement = document.getElementById('videoAttachmentSize');

                        nameElement.textContent = file.name;
                        const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                        sizeElement.textContent = `${sizeMB} MB`;
                        indicator.style.display = 'block';

                        console.log('‚úì Manual video loaded successfully');
                    }
                });
            }
        });

        // Remove image attachment
        function removeImageAttachment() {
            const imageInput = document.getElementById('lipsyncImage');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');

            // Clear file input
            imageInput.value = '';

            // Hide preview
            imagePreview.style.display = 'none';
            previewImg.src = '';

            console.log('‚úì Image attachment removed');
        }

        // Remove video attachment
        function removeVideoAttachment() {
            const videoInput = document.getElementById('manualVideoUpload');
            const indicator = document.getElementById('videoAttachmentIndicator');
            const videoPlayer = document.getElementById('lipsyncVideoPlayer');
            const videoSource = document.getElementById('lipsyncVideoSource');
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            const expandBtn = document.getElementById('expandVideoBtn');
            const downloadBtn = document.getElementById('downloadVideoBtn');
            const pushBtn = document.getElementById('pushToEmailBtn');

            // Clear file input
            videoInput.value = '';

            // Hide indicator
            indicator.style.display = 'none';

            // Hide video player, show placeholder
            videoPlayer.style.display = 'none';
            videoPlaceholder.style.display = 'flex';
            videoSource.src = '';

            // Hide action buttons
            expandBtn.style.display = 'none';
            downloadBtn.style.display = 'none';
            pushBtn.style.display = 'none';

            // Clear current video URL
            if (currentVideoUrl) {
                URL.revokeObjectURL(currentVideoUrl);
                currentVideoUrl = null;
            }

            console.log('‚úì Video attachment removed');
        }

        // Generate lipsync video
        async function generateLipsyncVideo() {
            const imageInput = document.getElementById('lipsyncImage');
            const videoPrompt = document.getElementById('videoPrompt').value.trim();

            // Validation
            if (!imageInput.files || !imageInput.files[0]) {
                alert('Please upload an image first');
                return;
            }

            if (!currentAudioBlob) {
                alert('Please generate audio first in the Spark The Magic panel');
                return;
            }

            // Show progress indicator
            const progressContainer = document.getElementById('videoProgressContainer');
            const progressText = document.getElementById('videoProgressText');
            const generateButton = document.getElementById('generateVideoBtn');
            const originalText = generateButton.textContent;

            generateButton.textContent = 'Processing...';
            generateButton.disabled = true;
            progressContainer.classList.add('active');
            progressText.textContent = 'Uploading files...';
            document.getElementById('videoCompletionMessage').style.display = 'none';
            animateVideoProgressBar();

            try {
                // Create FormData
                const formData = new FormData();
                formData.append('image', imageInput.files[0]);
                formData.append('audio', currentAudioBlob, 'audio.mp3');
                if (videoPrompt) {
                    formData.append('prompt', videoPrompt);
                }

                // Calculate estimated processing time based on audio duration
                let estimatedMinutes = 5; // Default
                try {
                    const audio = new Audio(URL.createObjectURL(currentAudioBlob));
                    await new Promise((resolve) => {
                        audio.addEventListener('loadedmetadata', () => {
                            const audioDuration = audio.duration;
                            // TopView takes ~45 seconds to render 1 second of video
                            estimatedMinutes = Math.ceil((audioDuration * 45) / 60);
                            resolve();
                        });
                    });
                } catch (err) {
                    console.warn('Could not calculate duration, using default:', err);
                }

                progressText.textContent = `Your video is busy processing, please go make yourself a coffee or stretch your legs. Preview will be ready in approx ${estimatedMinutes} minute${estimatedMinutes !== 1 ? 's' : ''}`;

                // Call backend
                const response = await fetch('/api/generate-lipsync', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    try {
                        const errorData = await response.json();
                        console.error('Backend error response:', errorData);
                        const errorMsg = errorData.message || errorData.error || `HTTP ${response.status}: Failed to generate lipsync video`;
                        throw new Error(errorMsg);
                    } catch (parseError) {
                        if (parseError instanceof SyntaxError) {
                            const text = await response.text();
                            console.error('Non-JSON error response:', text);
                            throw new Error(`HTTP ${response.status}: ${text.substring(0, 200)}`);
                        }
                        throw parseError;
                    }
                }

                const data = await response.json();

                if (data.success && data.video_url) {
                    progressText.textContent = 'Loading video preview...';

                    // Store original URL
                    currentVideoUrl = data.video_url;
                    const videoPlayer = document.getElementById('lipsyncVideoPlayer');
                    const videoSource = document.getElementById('lipsyncVideoSource');
                    const videoPlaceholder = document.getElementById('videoPlaceholder');
                    const downloadBtn = document.getElementById('downloadVideoBtn');

                    console.log('Video URL received:', data.video_url);

                    // Check if it's a local URL or external S3 URL
                    const isLocalVideo = data.video_url.startsWith('/static/');

                    let finalVideoUrl;
                    if (isLocalVideo) {
                        // Local video - use directly, no need for proxy
                        console.log('Using local video URL directly');
                        finalVideoUrl = data.video_url;
                    } else {
                        // External S3 URL - use proxy to avoid CORS issues
                        console.log('Using proxy for external video URL');
                        finalVideoUrl = `/api/proxy-video?url=${encodeURIComponent(data.video_url)}`;
                    }

                    // Fetch video as blob for better compatibility
                    progressText.textContent = 'Preparing video for playback...';
                    const videoResponse = await fetch(finalVideoUrl);

                    // Get the response as array buffer and create a proper MP4 blob
                    const videoArrayBuffer = await videoResponse.arrayBuffer();
                    const videoBlob = new Blob([videoArrayBuffer], { type: 'video/mp4' });
                    const videoBlobUrl = URL.createObjectURL(videoBlob);

                    console.log('Video blob created, size:', videoBlob.size, 'type:', videoBlob.type);

                    // Set video source with blob URL
                    videoSource.src = videoBlobUrl;
                    videoSource.type = 'video/mp4';
                    videoPlayer.load();
                    videoPlayer.style.display = 'block';
                    videoPlaceholder.style.display = 'none';
                    downloadBtn.style.display = 'block';
                    document.getElementById('expandVideoBtn').style.display = 'block';
                    document.getElementById('pushToEmailBtn').style.display = 'block';

                    // Add error handler for video
                    videoPlayer.onerror = function(e) {
                        console.error('Video player error:', e);
                        console.error('Video network state:', videoPlayer.networkState);
                        console.error('Video ready state:', videoPlayer.readyState);
                        console.error('Video source:', videoSource.src);
                        console.error('Original URL:', currentVideoUrl);
                        alert('Video playback error. The video has been generated but cannot be played in the browser. Please download it instead.');
                    };

                    // Add success handler
                    videoPlayer.onloadeddata = function() {
                        console.log('‚úì Video loaded successfully and ready to play');
                        completeVideoProgressBar();
                        progressText.textContent = 'Video ready!';
                        setTimeout(() => {
                            progressContainer.classList.remove('active');
                        }, 1000);
                    };

                    // Try to play the video
                    videoPlayer.play().catch(err => {
                        console.log('Autoplay prevented:', err);
                    });

                    alert('Lipsync video generated successfully!');
                } else {
                    throw new Error('No video URL returned');
                }

            } catch (error) {
                console.error('Lipsync generation error:', error);
                alert('Error generating lipsync video: ' + error.message);
                resetVideoProgressBar();
                progressContainer.classList.remove('active');
            } finally {
                // Restore button state
                generateButton.textContent = originalText;
                generateButton.disabled = false;
            }
        }

        // Download lipsync video
        async function downloadLipsyncVideo() {
            if (!currentVideoUrl) {
                alert('No video to download');
                return;
            }

            try {
                // Show loading state
                const downloadBtn = document.getElementById('downloadVideoBtn');
                const originalText = downloadBtn.textContent;
                downloadBtn.textContent = 'Downloading...';
                downloadBtn.disabled = true;

                console.log('Fetching video from:', currentVideoUrl);

                // Determine fetch URL based on whether it's local or external
                const isLocalVideo = currentVideoUrl.startsWith('/static/');
                const fetchUrl = isLocalVideo ? currentVideoUrl : currentVideoUrl;

                // Fetch the video as a blob
                const response = await fetch(fetchUrl, {
                    mode: 'cors',
                    credentials: 'omit'
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch video: ${response.status}`);
                }

                const blob = await response.blob();
                console.log('Video downloaded, size:', blob.size, 'bytes');

                // Create download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lipsync_video_${Date.now()}.mp4`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // Clean up
                URL.revokeObjectURL(url);

                // Restore button state
                downloadBtn.textContent = originalText;
                downloadBtn.disabled = false;

            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading video: ' + error.message + '\n\nYou can try right-clicking the video and selecting "Save video as..."');

                // Restore button state
                const downloadBtn = document.getElementById('downloadVideoBtn');
                downloadBtn.textContent = 'Download Video';
                downloadBtn.disabled = false;
            }
        }

        // Expand video to modal
        function expandVideo() {
            const mainVideoSource = document.getElementById('lipsyncVideoSource');
            const modalVideoSource = document.getElementById('modalVideoSource');
            const modal = document.getElementById('videoModal');
            const modalPlayer = document.getElementById('modalVideoPlayer');

            // Copy video source to modal
            modalVideoSource.src = mainVideoSource.src;
            modalVideoSource.type = mainVideoSource.type;
            modalPlayer.load();

            // Show modal
            modal.classList.add('active');

            // Play video in modal
            modalPlayer.play().catch(err => {
                console.log('Autoplay prevented in modal:', err);
            });
        }

        // Close video modal
        function closeVideoModal() {
            const modal = document.getElementById('videoModal');
            const modalPlayer = document.getElementById('modalVideoPlayer');

            // Pause video
            modalPlayer.pause();

            // Hide modal
            modal.classList.remove('active');
        }

        // Close modal when clicking outside the video
        document.getElementById('videoModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeVideoModal();
            }
        });

        // Close modal with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeVideoModal();
            }
        });

        // ============================================================================
        // Voice Selection Modal Functions
        // ============================================================================
        let cachedVoices = null;

        // Open voice selection modal
        async function openVoiceModal() {
            const modal = document.getElementById('voiceModal');
            modal.classList.add('active');

            // If voices are already cached, display them
            if (cachedVoices) {
                displayVoices(cachedVoices);
                return;
            }

            // Show loading state
            document.getElementById('voiceLoadingMessage').style.display = 'block';
            document.getElementById('voiceErrorMessage').style.display = 'none';
            document.getElementById('voiceListContainer').style.display = 'none';

            try {
                const response = await fetch('/api/elevenlabs-voices');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch voices');
                }

                cachedVoices = data.voices;
                displayVoices(cachedVoices);
            } catch (error) {
                console.error('Error fetching voices:', error);
                document.getElementById('voiceLoadingMessage').style.display = 'none';
                document.getElementById('voiceErrorMessage').style.display = 'block';
                document.getElementById('voiceErrorMessage').textContent =
                    `Failed to load voices: ${error.message}`;
            }
        }

        // Display voices in the modal
        function displayVoices(voices) {
            document.getElementById('voiceLoadingMessage').style.display = 'none';
            document.getElementById('voiceErrorMessage').style.display = 'none';
            document.getElementById('voiceListContainer').style.display = 'block';

            const voiceList = document.getElementById('voiceList');
            voiceList.innerHTML = '';

            if (!voices || voices.length === 0) {
                voiceList.innerHTML = '<p style="text-align: center; color: #6b7280;">No voices found</p>';
                return;
            }

            voices.forEach(voice => {
                const voiceItem = document.createElement('div');
                voiceItem.className = 'voice-item';
                voiceItem.onclick = () => selectVoice(voice.voice_id, voice.name);

                // Get labels text
                const labelsText = voice.labels && Object.keys(voice.labels).length > 0
                    ? Object.entries(voice.labels).map(([key, value]) => `${key}: ${value}`).join(', ')
                    : '';

                voiceItem.innerHTML = `
                    <div class="voice-item-info">
                        <div class="voice-item-name">${voice.name}</div>
                        <div class="voice-item-id">${voice.voice_id}</div>
                        ${labelsText ? `<div class="voice-item-labels">${labelsText}</div>` : ''}
                    </div>
                    ${voice.category ? `<span class="voice-item-category">${voice.category}</span>` : ''}
                `;

                voiceList.appendChild(voiceItem);
            });
        }

        // Select a voice and close the modal
        function selectVoice(voiceId, voiceName) {
            document.getElementById('voiceId').value = voiceId;
            closeVoiceModal();
            console.log(`Selected voice: ${voiceName} (${voiceId})`);
        }

        // Close voice selection modal
        function closeVoiceModal() {
            const modal = document.getElementById('voiceModal');
            modal.classList.remove('active');
        }

        // Close voice modal when clicking outside
        document.getElementById('voiceModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeVoiceModal();
            }
        });

        // ============================================================================
        // Settings Modal Functions
        // ============================================================================

        // Open settings modal
        function openSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.classList.add('active');
            // Load current settings when opening
            loadSettings();
            // Load admin panel if user is admin
            if (currentUser && currentUser.is_admin) {
                document.getElementById('adminPanelSection').style.display = 'block';
                refreshPendingUsers();
            }
        }

        // Close settings modal
        function closeSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('active');
        }

        // Close settings modal when clicking outside
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettingsModal();
            }
        });

        // Close settings modal with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const settingsModal = document.getElementById('settingsModal');
                if (settingsModal.classList.contains('active')) {
                    closeSettingsModal();
                }
            }
        });

        // ============================================================================
        // Admin Panel Functions
        // ============================================================================

        async function refreshPendingUsers() {
            const listContainer = document.getElementById('pendingUsersList');
            listContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 1rem;">Loading...</div>';

            try {
                const response = await fetch('/api/admin/pending-users');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch pending users');
                }

                if (data.pending_users.length === 0) {
                    listContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 1rem;">No pending approvals</div>';
                    return;
                }

                listContainer.innerHTML = data.pending_users.map(user => `
                    <div style="background: rgba(255, 255, 255, 0.08); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem;">
                        <div style="margin-bottom: 0.5rem;">
                            <div style="font-weight: bold;">${user.email}</div>
                            <div style="font-size: 0.85rem; color: #999;">@${user.username}</div>
                            <div style="font-size: 0.8rem; color: #999;">Registered: ${new Date(user.created_at).toLocaleDateString()}</div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-primary compact-btn" onclick="approveUser(${user.id})" style="flex: 1; padding: 0.4rem;">‚úì Approve</button>
                            <button class="btn-download" onclick="rejectUser(${user.id})" style="flex: 1; padding: 0.4rem; background: #dc2626;">‚úó Reject</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error fetching pending users:', error);
                listContainer.innerHTML = '<div style="text-align: center; color: #dc2626; padding: 1rem;">Error loading users</div>';
            }
        }

        async function approveUser(userId) {
            if (!confirm('Approve this user?')) return;

            try {
                const response = await fetch('/api/admin/approve-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to approve user');
                }

                alert(`‚úì User ${data.user.email} has been approved!`);
                refreshPendingUsers();

            } catch (error) {
                console.error('Error approving user:', error);
                alert('Error: ' + error.message);
            }
        }

        async function rejectUser(userId) {
            if (!confirm('Reject this user? This will delete their account and send them a notification email.')) return;

            try {
                const response = await fetch('/api/admin/reject-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, notify: true })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to reject user');
                }

                alert(`‚úì ${data.message}`);
                refreshPendingUsers();

            } catch (error) {
                console.error('Error rejecting user:', error);
                alert('Error: ' + error.message);
            }
        }

        async function viewAllUsers() {
            try {
                const response = await fetch('/api/admin/all-users');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch users');
                }

                const userList = data.users.map(user => {
                    const status = user.verified ? '‚úì Approved' : '‚è≥ Pending';
                    const adminBadge = user.is_admin ? ' üëë Admin' : '';
                    const lastLogin = user.last_login ? new Date(user.last_login).toLocaleString() : 'Never';
                    return `${user.email} (${user.username}) - ${status}${adminBadge} - Last login: ${lastLogin}`;
                }).join('\n');

                alert(`All Users (${data.users.length}):\n\n${userList}`);

            } catch (error) {
                console.error('Error fetching all users:', error);
                alert('Error: ' + error.message);
            }
        }

        // Email template variables
        let currentGifUrl = null;

        // Push video to email panel (uploads to Cloudinary and converts to GIF)
        async function pushToEmail() {
            if (!currentVideoUrl) {
                alert('No video available. Please generate a video first.');
                return;
            }

            const pushBtn = document.getElementById('pushToEmailBtn');
            const originalText = pushBtn.textContent;

            try {
                pushBtn.textContent = 'Uploading to cloud...';
                pushBtn.disabled = true;

                // Check if URL is external (S3) and needs proxy
                const isExternal = !currentVideoUrl.startsWith('blob:') && !currentVideoUrl.startsWith('/static/');
                const fetchUrl = isExternal
                    ? `/api/proxy-video?url=${encodeURIComponent(currentVideoUrl)}`
                    : currentVideoUrl;

                console.log('Fetching video for email upload:', isExternal ? 'using proxy' : 'direct');

                // Convert blob URL to File object
                const videoBlob = await fetch(fetchUrl).then(r => r.blob());
                const videoFile = new File([videoBlob], 'lipsync-video.mp4', { type: 'video/mp4' });

                // Create FormData for upload
                const formData = new FormData();
                formData.append('video', videoFile);
                formData.append('convert_to_gif', 'true');
                formData.append('gif_duration', '5'); // First 5 seconds as GIF

                pushBtn.textContent = 'Converting to GIF...';

                // Upload to Cloudinary
                const response = await fetch('/api/upload-to-cloudinary', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Upload failed');
                }

                const data = await response.json();

                // Store the public URLs
                currentGifUrl = data.gif_url || data.video_url;
                document.getElementById('emailVideoLink').value = data.video_url;

                // Update email preview
                updateEmailPreview();

                // Scroll to email panel
                const emailPanel = document.querySelector('[data-panel="4"]');
                if (emailPanel) {
                    emailPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
                }

                // Restore button
                pushBtn.textContent = originalText;
                pushBtn.disabled = false;

                alert('‚úì Video uploaded and converted to GIF! Check Panel 5 to customize and send your email.');

            } catch (error) {
                console.error('Push to email error:', error);
                alert('Error: ' + error.message);

                pushBtn.textContent = originalText;
                pushBtn.disabled = false;
            }
        }

        // Update email preview
        function updateEmailPreview() {
            const headline = document.getElementById('emailHeadline').value;
            const intro = document.getElementById('emailIntro').value;
            const bullets = document.getElementById('emailBullets').value;
            const closing = document.getElementById('emailClosing').value;
            const videoLink = document.getElementById('emailVideoLink').value;
            const primaryColor = document.getElementById('emailPrimaryColor').value;
            const accentColor = document.getElementById('emailAccentColor').value;

            // Parse bullets (one per line)
            const bulletList = bullets.split('\n').filter(b => b.trim()).map(b => `<li style="margin-bottom: 12px; line-height: 1.6;">${escapeHtml(b.trim())}</li>`).join('');

            // Create beautiful HTML email template
            const emailHTML = `
                <div style="max-width: 600px; margin: 0 auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #ffffff;">
                    <!-- Header -->
                    <div style="background-color: ${primaryColor}; background: linear-gradient(135deg, ${primaryColor} 0%, ${accentColor} 100%); padding: 40px 30px; text-align: center; border-radius: 8px 8px 0 0;">
                        <h1 style="color: #ffffff; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: -0.5px;">${escapeHtml(headline)}</h1>
                    </div>

                    <!-- Body -->
                    <div style="padding: 40px 30px; background: #ffffff;">
                        <!-- Intro -->
                        <p style="color: #1a2832; font-size: 16px; line-height: 1.6; margin: 0 0 30px 0;">${escapeHtml(intro)}</p>

                        <!-- GIF Embed -->
                        ${currentGifUrl ? `
                        <div style="text-align: center; margin: 30px 0;">
                            <a href="${escapeHtml(videoLink || currentGifUrl)}" style="display: inline-block; text-decoration: none;">
                                <img
                                    src="${escapeHtml(currentGifUrl)}"
                                    alt="Video preview"
                                    style="width: 100%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); cursor: pointer; display: block;">
                            </a>
                            <p style="margin: 10px 0 0 0; font-size: 13px; color: #6b7280;">Click to watch full video</p>
                        </div>
                        ` : ''}

                        <!-- Bullet Points -->
                        <div style="background: #f9fafb; border-left: 4px solid ${primaryColor}; padding: 20px 25px; margin: 30px 0; border-radius: 4px;">
                            <ul style="margin: 0; padding: 0; list-style: none;">
                                ${bulletList}
                            </ul>
                        </div>

                        <!-- Closing -->
                        <p style="color: #1a2832; font-size: 16px; line-height: 1.6; margin: 30px 0 0 0;">${escapeHtml(closing)}</p>

                        <!-- CTA Button -->
                        ${videoLink ? `
                        <div style="text-align: center; margin: 40px 0 20px 0;">
                            <a href="${escapeHtml(videoLink)}" style="display: inline-block; background-color: ${primaryColor}; background: linear-gradient(135deg, ${primaryColor} 0%, ${accentColor} 100%); color: #ffffff; padding: 14px 32px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 12px rgba(${hexToRgb(primaryColor)}, 0.3);">Watch Full Video</a>
                        </div>
                        ` : ''}
                    </div>

                    <!-- Footer -->
                    <div style="background: #f9fafb; padding: 30px; text-align: center; border-radius: 0 0 8px 8px; border-top: 1px solid #e5e7eb;">
                        <p style="margin: 0; color: #6b7280; font-size: 14px;">Powered by SupaReports</p>
                    </div>
                </div>
            `;

            document.getElementById('emailPreview').innerHTML = emailHTML;
        }

        // Helper function to convert hex to RGB for box-shadow
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '80, 200, 120';
        }

        // Copy email HTML to clipboard
        async function copyEmailHTML() {
            const emailPreview = document.getElementById('emailPreview');
            const html = emailPreview.innerHTML;

            try {
                await navigator.clipboard.writeText(html);
                alert('Email HTML copied to clipboard! You can now paste it into your email client.');
            } catch (error) {
                console.error('Copy error:', error);
                // Fallback: create a temporary textarea
                const textarea = document.createElement('textarea');
                textarea.value = html;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    alert('Email HTML copied to clipboard! You can now paste it into your email client.');
                } catch (fallbackError) {
                    alert('Failed to copy. Please manually select and copy the email preview.');
                }
                document.body.removeChild(textarea);
            }
        }

        // Send email directly
        async function sendEmail() {
            const senderEmail = document.getElementById('senderEmail').value.trim();
            const recipientEmails = document.getElementById('recipientEmails').value.trim();
            const emailSubject = document.getElementById('emailSubject').value.trim();
            const emailPreview = document.getElementById('emailPreview');
            const htmlContent = emailPreview.innerHTML;

            // Validation
            if (!senderEmail) {
                alert('Please enter your email address');
                return;
            }

            if (!recipientEmails) {
                alert('Please enter recipient email address(es)');
                return;
            }

            if (!emailSubject) {
                alert('Please enter an email subject');
                return;
            }

            if (!htmlContent || htmlContent.trim() === '') {
                alert('Please generate email content first by clicking "Update Preview"');
                return;
            }

            // Split recipients by comma
            const recipients = recipientEmails.split(',').map(e => e.trim()).filter(e => e);

            // Show sending message
            const sendButton = event.target;
            const originalText = sendButton.innerHTML;
            sendButton.disabled = true;
            sendButton.innerHTML = 'üìß Sending...';

            try {
                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        from_email: senderEmail,
                        to_emails: recipients,
                        subject: emailSubject,
                        html_content: htmlContent
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    const error = new Error(errorData.message || errorData.error || 'Failed to send email');
                    error.details = errorData.details || errorData.message;
                    throw error;
                }

                const data = await response.json();
                alert(`‚úì Email sent successfully to ${recipients.length} recipient${recipients.length !== 1 ? 's' : ''}!`);
                console.log('Email sent:', data);

            } catch (error) {
                console.error('Send email error:', error);
                const errorDetails = error.details || error.message || 'Unknown error';
                alert('Failed to send email: ' + errorDetails);
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = originalText;
            }
        }

        // Initialize email preview on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Clear all form fields on page load/refresh
            const analysisForm = document.getElementById('analysisForm');
            if (analysisForm) {
                analysisForm.reset();
            }

            updateEmailPreview();
            loadSettings();
            setupSettingsPreviews();
        });

        // ============================================================================
        // Settings Functions
        // ============================================================================

        // Load settings from localStorage
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('supaReportsSettings') || '{}');

            const displayNameInput = document.getElementById('settingsDisplayName');
            if (settings.displayName && displayNameInput) {
                displayNameInput.value = settings.displayName;
            }

            const emailInput = document.getElementById('settingsEmailAddress');
            if (settings.emailAddress && emailInput) {
                emailInput.value = settings.emailAddress;
                const senderEmail = document.getElementById('senderEmail');
                if (senderEmail && !senderEmail.value) {
                    senderEmail.value = settings.emailAddress;
                }
            }

            const avatarPreviewImg = document.getElementById('avatarPreviewImg');
            const avatarPreview = document.getElementById('avatarPreview');
            if (settings.avatar && avatarPreviewImg && avatarPreview) {
                avatarPreviewImg.src = settings.avatar;
                avatarPreview.style.display = 'block';
                updateUserAvatar(settings.avatar);
            }

            const bgPreviewImg = document.getElementById('backgroundPreviewImg');
            const bgPreview = document.getElementById('backgroundPreview');
            if (settings.backgroundImage && bgPreviewImg && bgPreview) {
                applyBackgroundImage(settings.backgroundImage);
                bgPreviewImg.src = settings.backgroundImage;
                bgPreview.style.display = 'block';
            }
        }

        async function saveSettings() {
            const settings = {
                displayName: document.getElementById('settingsDisplayName').value,
                emailAddress: document.getElementById('settingsEmailAddress').value,
            };

            const avatarFile = document.getElementById('settingsAvatarUpload').files[0];
            if (avatarFile) {
                if (avatarFile.size > 2 * 1024 * 1024) {
                    alert('Avatar file is too large. Maximum size is 2MB.');
                    return;
                }
                settings.avatar = await fileToBase64(avatarFile);
            } else {
                const existing = JSON.parse(localStorage.getItem('supaReportsSettings') || '{}');
                if (existing.avatar) settings.avatar = existing.avatar;
            }

            const bgFile = document.getElementById('settingsBackgroundUpload').files[0];
            if (bgFile) {
                if (bgFile.size > 5 * 1024 * 1024) {
                    alert('Background file is too large. Maximum size is 5MB.');
                    return;
                }
                settings.backgroundImage = await fileToBase64(bgFile);
            } else {
                const existing = JSON.parse(localStorage.getItem('supaReportsSettings') || '{}');
                if (existing.backgroundImage) settings.backgroundImage = existing.backgroundImage;
            }

            localStorage.setItem('supaReportsSettings', JSON.stringify(settings));

            if (settings.avatar) updateUserAvatar(settings.avatar);
            if (settings.backgroundImage) applyBackgroundImage(settings.backgroundImage);

            alert('‚úì Settings saved successfully!');
            closeSettingsModal();
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function updateUserAvatar(avatarSrc) {
            const userAvatar = document.querySelector('.user-avatar');
            if (userAvatar) {
                userAvatar.style.backgroundImage = `url(${avatarSrc})`;
                userAvatar.style.backgroundSize = 'cover';
                userAvatar.style.backgroundPosition = 'center';
                userAvatar.textContent = '';
            }
        }

        function applyBackgroundImage(imageSrc) {
            const background = document.querySelector('.background');
            if (background) {
                background.style.backgroundImage = `url(${imageSrc})`;
            }
        }

        function resetBackground() {
            const settings = JSON.parse(localStorage.getItem('supaReportsSettings') || '{}');
            delete settings.backgroundImage;
            localStorage.setItem('supaReportsSettings', JSON.stringify(settings));

            const background = document.querySelector('.background');
            if (background) {
                background.style.backgroundImage = "url('SupaReportsBG.jpg')";
            }

            // Clear file input
            const bgUpload = document.getElementById('settingsBackgroundUpload');
            if (bgUpload) {
                bgUpload.value = '';
            }

            document.getElementById('backgroundPreview').style.display = 'none';
            alert('‚úì Background reset to default');
        }

        function clearAvatar() {
            // Clear the preview
            document.getElementById('avatarPreview').style.display = 'none';

            // Clear the file input
            const avatarUpload = document.getElementById('settingsAvatarUpload');
            if (avatarUpload) {
                avatarUpload.value = '';
            }

            // Remove from localStorage
            const settings = JSON.parse(localStorage.getItem('supaReportsSettings') || '{}');
            delete settings.avatar;
            localStorage.setItem('supaReportsSettings', JSON.stringify(settings));

            // Reset user avatar to default (initials)
            const userAvatar = document.querySelector('.user-avatar');
            if (userAvatar) {
                userAvatar.style.backgroundImage = '';
                // Could set default initials here if needed
            }
        }

        function clearBackground() {
            // Clear the preview
            document.getElementById('backgroundPreview').style.display = 'none';

            // Clear the file input
            const bgUpload = document.getElementById('settingsBackgroundUpload');
            if (bgUpload) {
                bgUpload.value = '';
            }

            // Remove from localStorage
            const settings = JSON.parse(localStorage.getItem('supaReportsSettings') || '{}');
            delete settings.backgroundImage;
            localStorage.setItem('supaReportsSettings', JSON.stringify(settings));

            // Reset to default background
            const background = document.querySelector('.background');
            if (background) {
                background.style.backgroundImage = "url('SupaReportsBG.jpg')";
            }
        }

        function setupSettingsPreviews() {
            const avatarUpload = document.getElementById('settingsAvatarUpload');
            if (avatarUpload) {
                avatarUpload.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            document.getElementById('avatarPreviewImg').src = event.target.result;
                            document.getElementById('avatarPreview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            const bgUpload = document.getElementById('settingsBackgroundUpload');
            if (bgUpload) {
                bgUpload.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            document.getElementById('backgroundPreviewImg').src = event.target.result;
                            document.getElementById('backgroundPreview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }

    </script>
</body>
</html>
